<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.0">
<meta name="author" content="Mario Garcia">
<title>Functional Groovy</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Noto+Serif:400,400italic,700,700italic|Droid+Sans+Mono:400">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Noto+Serif:400,400italic,700,700italic|Droid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-check-square-o:first-child,ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p,blockquote,dt,td.content{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after,a[href^="mailto:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img{page-break-inside:avoid}
thead{display:table-header-group}
img{max-width:100%!important}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>document.addEventListener('DOMContentLoaded', prettyPrint)</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.4.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Functional Groovy</h1>
<div class="details">
<span id="author" class="author">Mario Garcia</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_intro">1. Intro</a></li>
<li><a href="#_closures">2. Closures</a>
<ul class="sectlevel2">
<li><a href="#_definition">2.1. Definition</a></li>
<li><a href="#_getting_started">2.2. Getting started</a></li>
<li><a href="#_composition">2.3. Composition</a></li>
<li><a href="#_currying">2.4. Currying</a>
<ul class="sectlevel3">
<li><a href="#_what_is_currying">2.4.1. What is currying ?</a></li>
<li><a href="#_using_curry_ncurry_rcurry">2.4.2. Using curry, ncurry, rcurry</a></li>
<li><a href="#_combining_closures">2.4.3. Combining closures</a></li>
</ul>
</li>
<li><a href="#_delegation_strategy">2.5. Delegation strategy</a>
<ul class="sectlevel3">
<li><a href="#_owner_first">2.5.1. OWNER FIRST</a></li>
<li><a href="#_owner_only">2.5.2. OWNER_ONLY</a></li>
<li><a href="#_delegate_first">2.5.3. DELEGATE FIRST</a></li>
<li><a href="#_delegate_owner">2.5.4. DELEGATE_OWNER</a></li>
</ul>
</li>
<li><a href="#_memoization">2.6. Memoization</a></li>
<li><a href="#_trampoline">2.7. Trampoline</a></li>
<li><a href="#_functional_interface_coercion">2.8. Functional interface coercion</a></li>
</ul>
</li>
<li><a href="#_internal_vs_external_iteration">3. Internal Vs External iteration</a>
<ul class="sectlevel2">
<li><a href="#_more_concise">3.1. More concise</a></li>
<li><a href="#_reusability">3.2. Reusability</a></li>
<li><a href="#_composition_2">3.3. Composition</a></li>
</ul>
</li>
<li><a href="#_streams">4. Streams</a>
<ul class="sectlevel2">
<li><a href="#_mind_the_lazyness">4.1. Mind the lazyness</a></li>
<li><a href="#_stream_groovy">4.2. stream-groovy</a>
<ul class="sectlevel3">
<li><a href="#_first_steps">4.2.1. First steps</a></li>
</ul>
</li>
<li><a href="#_creating_a_stream">4.3. Creating a Stream</a></li>
<li><a href="#_nba_time">4.4. NBA time</a></li>
</ul>
</li>
<li><a href="#_immutability">5. Immutability</a></li>
<li><a href="#_oop_revisited">6. OOP Revisited</a>
<ul class="sectlevel2">
<li><a href="#_state">6.1. State</a></li>
<li><a href="#_command">6.2. Command</a></li>
<li><a href="#_immutable_objects_instead_of_builder">6.3. Immutable objects instead of Builder</a></li>
<li><a href="#_replacing_iterator">6.4. Replacing Iterator</a></li>
<li><a href="#_template_pattern">6.5. Template pattern</a></li>
<li><a href="#_strategy">6.6. Strategy</a></li>
<li><a href="#_fighting_null_object">6.7. Fighting Null Object</a></li>
</ul>
</li>
<li><a href="#_functional_patterns">7. Functional Patterns</a></li>
<li><a href="#_functional_abstractions">8. Functional Abstractions</a>
<ul class="sectlevel2">
<li><a href="#_introduction">8.1. Introduction</a></li>
<li><a href="#_monoids">8.2. Monoids</a></li>
<li><a href="#_functor">8.3. Functor</a>
<ul class="sectlevel3">
<li><a href="#_example">8.3.1. Example</a></li>
<li><a href="#_function_a_b">8.3.2. Function (a&#8594;b)</a></li>
<li><a href="#_functor_a">8.3.3. Functor&lt;A&gt;</a></li>
<li><a href="#_plain_groovy">8.3.4. Plain Groovy</a></li>
</ul>
</li>
<li><a href="#_applicative_functor">8.4. Applicative Functor</a>
<ul class="sectlevel3">
<li><a href="#_example_2">8.4.1. Example</a></li>
</ul>
</li>
<li><a href="#_monad">8.5. Monad</a>
<ul class="sectlevel3">
<li><a href="#_maybe">8.5.1. Maybe</a></li>
<li><a href="#_either">8.5.2. Either</a></li>
<li><a href="#_listmonad">8.5.3. ListMonad</a></li>
<li><a href="#_try">8.5.4. Try</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_persistent_collections">9. Persistent collections</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_intro">1. Intro</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(TODO)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_closures">2. Closures</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_definition">2.1. Definition</h3>
<div class="paragraph">
<p>Until I find a better definition, I came up with the following "informal" definition:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A <strong><em>closure</em></strong> is a function which allows access to variables declared in its surrounding scope when
the closure was declared.</p>
</div>
<div class="paragraph">
<p>Normally this surrounding scope in Groovy means local variables and non-local variables inside its
upper lexical scopes up to class fields.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The minimal version of a closure could be:</p>
</div>
<div class="listingblock">
<div class="title">Declaring a closure</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def closure = { -&gt; }

def closureWithArgs = { arg1, arg2 -&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    println "statements" <i class="conum" data-value="2"></i><b>(2)</b>
}

def closureWithImplicit = {
    println it <i class="conum" data-value="3"></i><b>(3)</b>
}

Closure&lt;?&gt; typedClosure = {-&gt; } <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A closure may have closure aguments</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A closure body may have statements</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A closure may have an implicit variable</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Closures always return a value (even though it could be void).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Closures can be declared in as class fields, static fields, and local variables.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;ve included the typed version because sometimes people forgot about the fact that a closure is a
function, and like any other function it could return something.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lets review the principals of a closure:</p>
</div>
<div class="listingblock">
<div class="title">Using a closure</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Declaring and executing a closure'() {
    given: 'a variable and a closure'
        def x = 1 <i class="conum" data-value="1"></i><b>(1)</b>
        def c = { -&gt;
            def y = 1 <i class="conum" data-value="2"></i><b>(2)</b>
            x + y <i class="conum" data-value="3"></i><b>(3)</b>
        }
    when: 'executing the closure'
        def result = c() <i class="conum" data-value="4"></i><b>(4)</b>
    then: 'the value should be the expected'
        result == 2
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A closure can access non-local variables available in upper lexical scopes when the closure was declared</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A closure can access local variables</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Has its own execution body</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Because it is a function, can be executed</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Closures may reference variables external to their own definition. This includes local variables,
method parameters, and object instance members. However, a closure may only reference those
variables that the compiler can lexically deduce from the physical location of the closure
definition within the source file.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It&#8217;s very important to keep in mind that a closure "sees" those variables available when the closure
was declared, not when it&#8217;s used.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_getting_started">2.2. Getting started</h3>
<div class="paragraph">
<p>Closures are widely used in Groovy. One of the most common places are collections. In the
following example we want to get 2 times each element of the collection.</p>
</div>
<div class="listingblock">
<div class="title">Using closures in API</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Using closures with collections (I)'() {
    given: 'a collection of numbers'
        def numbers = [1, 2, 3, 4]
    when: 'collecting the double of each of them'
        def doubledNumbers = numbers.collect { it * 2 } <i class="conum" data-value="1"></i><b>(1)</b>
    then:
        doubledNumbers == [2, 4, 6, 8]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The collect method receives a parameter of type <strong><em>Closure</em></strong> that transforms every item in
the collection.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Anonymous closure with implicit variable. In this case the variable refers to every
element in the collection.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also declare the closure and use it later as a parameter to another function.</p>
</div>
<div class="listingblock">
<div class="title">Using closures in API</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Using closures with collections (II)'() {
    given: 'a collection of numbers'
        def numbers = [1, 2, 3, 4]
    when: 'collecting the double of each of them'
        def collector = { it * 2 } <i class="conum" data-value="1"></i><b>(1)</b>
        def doubledNumbers = numbers.collect(collector) <i class="conum" data-value="2"></i><b>(2)</b>
    then:
        doubledNumbers == [2, 4, 6, 8]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declaring the closure</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Passing closures as parameters to other functions (closures or methods)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_composition">2.3. Composition</h3>
<div class="paragraph">
<p>Sometimes we end with a lot of functions used all over the code, but many
times used in different ways, orders&#8230;&#8203;etc.</p>
</div>
<div class="paragraph">
<p>Imagine you have a problem and you only know there will be two numbers
as an input and the result will be decimal. Your boss tells you to
add them up until he knows what the final calculation will be.</p>
</div>
<div class="paragraph">
<p>Well it&#8217;s not that bad isn&#8217;t it ? It is going to be a simple sum, lets
hardcode it and leave it alone.</p>
</div>
<div class="listingblock">
<div class="title">Harcoding solution which is likely to change</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Integer calculate1(Integer... numbers) {
    return numbers.sum()
}

void 'Composition: Just one calculation. No composition'() {
    given: 'two numbers as input'
        def first = 1
        def second = 2
    when: 'invoking the function'
        def result = calculate1(first, second)
    then: 'we should be getting the sum'
        result == 3
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now your boss comes again and gives you the whole formula: All numbers should be
multiplied 2 times and then be divided by 10 and eventually yes they should be
added up.</p>
</div>
<div class="paragraph">
<p>Ok, now you have to modify your code:</p>
</div>
<div class="listingblock">
<div class="title">Modifying your logic</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Double calculate2(Integer... numbers) {
    return numbers
        .collect { it * 2 }
        .collect { it / 10 }
        .sum()
}

void 'Composition: Calculation gets bigger. No composition'() {
    given: 'two numbers as input'
        def first = 10
        def second = 20
    when: 'invoking the function'
        def result = calculate2(first, second)
    then: 'the result should be the expected'
        result == 6
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may be thinking the code is still legibible and there is nothing wrong to
keep it that way. Well I disagree. First of all you are looping the collection
twice, that could be a lot of numbers, be carefull with that. And the second &#8230;&#8203;
will see that later ;)</p>
</div>
<div class="paragraph">
<p>I&#8217;m going to compose first two functions to be applied only once per item before
adding up all numbers.</p>
</div>
<div class="listingblock">
<div class="title">Composing</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Double calculate3(Integer... numbers) {
    def twoTimes = { it * 2 } <i class="conum" data-value="1"></i><b>(1)</b>
    def divideByTen = { it / 10 } <i class="conum" data-value="2"></i><b>(2)</b>
    def composedFn = twoTimes &gt;&gt; divideByTen <i class="conum" data-value="3"></i><b>(3)</b>

    return numbers
        .collect(composedFn) <i class="conum" data-value="4"></i><b>(4)</b>
        .sum()
}

void 'Composition: Calculation gets bigger. Composing (I)'() {
    given: 'two numbers as input'
        def first = 10
        def second = 20
    when: 'invoking the function'
        def result = calculate3(first, second)
    then: 'the result should be the expected'
        result == 6
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declaring first part of the calculation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declaring second part of the calculation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Combining both of them. Execution will be from left to right. First multiplication,
then division</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Using the combined function per each item</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Composition could be done from left to right or the other way around, it depends on the developer&#8217;s
decision. But this has to change a little bit more. We still have our functions</p>
</div>
<div class="listingblock">
<div class="title">Composing</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy"><i class="conum" data-value="1"></i><b>(1)</b>
Double calculate4(Integer... numbers) {
    def operation =
        Calculations.divideByTen &lt;&lt;
        Calculations.twoTimes

    return numbers.collect(operation).sum()
}

<i class="conum" data-value="2"></i><b>(2)</b>
Double applyFunctionAndSum(Closure&lt;Number&gt; fn, Integer... numbers) {
    return numbers.collect(fn).sum()
}

void 'Composition: Calculation gets bigger. Composing (II)'() {
    given: 'two numbers as input'
        def first = 10
        def second = 20
    when: 'invoking the function'
        def result1 = calculate4(first, second) <i class="conum" data-value="3"></i><b>(3)</b>
        def result2 =
            applyFunctionAndSum(Calculations.twoTimes, first, second) <i class="conum" data-value="4"></i><b>(4)</b>
    then: 'the result should be the expected'
        result1 == 6
        result2 == 60
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I&#8217;ve moved functions that I will probably reuse to static methods. That way I can
combine them without harcode them in my methods</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In this method I describe the problem I&#8217;ve been dealing with. Applying a function
to a list of numbers that eventually are going to be added up.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>I&#8217;m using the composed function here</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>At this point I&#8217;m able to reuse the basic functionality to apply any single or
combined function to it.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_currying">2.4. Currying</h3>
<div class="sect3">
<h4 id="_what_is_currying">2.4.1. What is currying ?</h4>
<div class="paragraph">
<p>The term takes its name from the american mathematician Haskell Curry. A good formal definition
could be:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Currying is the technique of transforming a function that takes multiple arguments in such a way
that it can be called as a chain of functions each with a single argument.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Wikipedia
</div>
</div>
<div class="paragraph">
<p><em>Currying</em> is a special case of <strong><em>partial application</em></strong> which is:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In computer science, partial application (or partial function application) refers to the process of
fixing a number of arguments to a function, producing another function of smaller arity&#8230;&#8203;</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Wikipedia
</div>
</div>
<div class="paragraph">
<p>Why are both definitions important ? Well, although I&#8217;ve just showed you the formal definition of
both <em>currying</em> and <em>partial application</em> in Groovy we tend to use the term <em>currying</em> most of the
time meaning partial applications. From now on I will using the formal definitions mentioned above.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_curry_ncurry_rcurry">2.4.2. Using curry, ncurry, rcurry</h4>
<div class="paragraph">
<p>There are three specialized methods for the Closure type in order to produce
partial applications of your closures.</p>
</div>
<div class="paragraph">
<p>The first one is <strong><em>curry</em></strong>. This method takes a var-arg parameter in order to set any number of
available closure parameters and return the partial application of it.</p>
</div>
<div class="listingblock">
<div class="title">curry(&#8230;&#8203;)</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'curry(...): partial application'() {
    given: 'a function taking a certain number of args'
        def fn1 = { a, b, c -&gt; a + b + c } <i class="conum" data-value="1"></i><b>(1)</b>
    when: 'producting another functions'
        def fn2 = fn1.curry(1) <i class="conum" data-value="2"></i><b>(2)</b>
        def fn3 = fn1.curry(1, 2, 3) <i class="conum" data-value="3"></i><b>(3)</b>
    then: 'different applications'
        fn2(4, 5) == 10
        fn3() == 6
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A function having 3 parameters</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We set the first parameter of the source function producing a new function with
two parameters</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This time we may want to set all parameters to pospone the execution of the function</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using <strong><em>curry(&#8230;&#8203;)</em></strong> you can pass at most the same number of arguments of the source closure,
otherwise you will get an IllegalAgumentException. The parameters are set from left to right.</p>
</div>
<div class="paragraph">
<p>In case you wanted to produce partial applications of a given function applying fixed values
from right to left, then you should be using <strong><em>rcurry(&#8230;&#8203;)</em></strong> method.</p>
</div>
<div class="listingblock">
<div class="title">rcurry(&#8230;&#8203;)</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'rcurry(...): partial application'() {
    given: 'a source function'
        def fn1 = { String name, Integer age, String city -&gt;
            return "$name is $age and is from $city"
        }
    when: 'producing new funtions'
        def fn2 = fn1.rcurry('Madrid')
        def fn3 = fn1.rcurry(22, 'Barcelona')
    then: 'we could use them in several different ways'
        fn2('John', 37) == 'John is 37 and is from Madrid'
        fn3('Ronnie') == 'Ronnie is 22 and is from Barcelona'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong><em>rcurry</em></strong> may seem a little bit awkward because notice how parameters are passed
to <em>rcurry</em>. One may expect to keep inverse order from right to left, I mean&#8230;&#8203;
if we had this function:</p>
</div>
<div class="listingblock">
<div class="title">rcurry(&#8230;&#8203;) explanation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def myFunction = { String a, Integer b, Double c -&gt; /*...*/ }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to set two fixed parameters I may expect that rcurry should be applied like this:</p>
</div>
<div class="listingblock">
<div class="title">rcurry(&#8230;&#8203;) wrong use</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">// WRONG
def myFunction2 = myFunction1.rcurry(22.2, 3)</code></pre>
</div>
</div>
<div class="paragraph">
<p>But instead <em>rcurry</em> expects to kee the same order:</p>
</div>
<div class="listingblock">
<div class="title">rcurry(&#8230;&#8203;) correct</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">// CORRECT
def myFunction2 = myFunction1.rcurry(3, 22.2)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last but not least. If you would like to produce a partial application of a given closure for any
parameter at any position you can use <strong><em>ncurry</em></strong>.</p>
</div>
<div class="listingblock">
<div class="title">ncurry(&#8230;&#8203;)</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'ncurry(...): partial application'() {
    given: 'a source function'
        def fn1 = { String name, Integer age, String city -&gt;
            return "$name is $age and is from $city"
        }
    when: 'producing a new function'
        def fn2 = fn1.ncurry(1,22) <i class="conum" data-value="1"></i><b>(1)</b>
    then: 'we should get the expected result'
        fn2('John', 'Madrid') == 'John is 22 and is from Madrid'
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we want to set only the second parameter from the left hand side.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using <strong><em>ncurry</em></strong> you just place the cursor at a given point and start setting
fixed parameters from left to right.</p>
</div>
</div>
<div class="sect3">
<h4 id="_combining_closures">2.4.3. Combining closures</h4>
<div class="paragraph">
<p>The same way we wanted to compose functions to transform values, we may want to
do the same thing with filtering.</p>
</div>
<div class="paragraph">
<p>This time we will change perspective. Instead of applying composed filters I think it would be more
interesting how to aggregate filters in order to apply them, for example, to a collection.</p>
</div>
<div class="paragraph">
<p>Think about an SQL operation, we wouln&#8217;t want the database engine to apply
each filter for every row and aggregate the result from the previous execution, Would we?
That would be crazy ? So if the database engine doesn&#8217;t do it, neither do I.</p>
</div>
<div class="paragraph">
<p>Our starting point is the less efective implementation where we&#8217;re repeating our
loop per each filter</p>
</div>
<div class="listingblock">
<div class="title">Filtering several times</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Composing for filtering: no composition'() {
    given: 'a huge list of numbers'
        def numbers = (1..1000)
    when: 'applying several filters...wrong'
        def result =
            numbers
                .findAll { it % 2 == 0 }
                .findAll { it &gt; 100 }
                .sum()
    then: 'we should get the expected result'
        result == 247950
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I can&#8217;t combine both filters as I did with transformation in the previous chapter.  Because the
result of applying a filter is a boolean value. Than boolean value will be passed as the argument of
the next function in line, and it will fail because all our filters are expecting a number.</p>
</div>
<div class="paragraph">
<p>The strategy requires to apply a partial application of the function.  Let&#8217;s show how to do it with
normal <strong><em>Xcurry</em></strong> methods.</p>
</div>
<div class="listingblock">
<div class="title">Combining filters using rcurry</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Closure&lt;Boolean&gt; combineFiltersVerbose(final Closure&lt;Boolean&gt;... filters) {
    Closure&lt;Boolean&gt; allFiltersCombined = { Integer number, Closure&lt;Boolean&gt;... allFilters -&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        allFilters*.call(number).every()
    }

    return allFiltersCombined.rcurry(filters) <i class="conum" data-value="2"></i><b>(2)</b>
}

void 'Combining filters with rcurry'() {
    given: 'a huge list of numbers'
        def numbers = (1..1000)
    and: 'composing filtering'
        def even = { it % 2 == 0 }
        def greaterThanHundred = { it &gt; 100 }
        def byCriteria = combineFiltersVerbose(even, greaterThanHundred) <i class="conum" data-value="3"></i><b>(3)</b>
    when: 'applying several filters'
        def result = numbers.findAll(byCriteria).sum() <i class="conum" data-value="4"></i><b>(4)</b>
    then: 'we should get the expected result'
        result == 247950
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First we create a closure with two parameters. We need to add some filters. All filters should be executed for every number</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We need to use rcurry to set filters, because var-args arguments can only be the last parameter of a function</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Passing all filter we want to apply in order</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Filtering numbers</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we will be applying all filters for every single item, just once. We made
our filtering process more efficient. Well done !!</p>
</div>
<div class="paragraph">
<p>It&#8217;s true that sometimes it&#8217;s a little bit verbose to use <em>Xcurry(&#8230;&#8203;)</em> methods but
it&#8217;s also true that using that technique functions are more reusable.</p>
</div>
<div class="paragraph">
<p>Here there is another technique which consist of making functions return other functions. Eventually
is what <em>Xcurry(&#8230;&#8203;)</em> methods will do for you underneath, but sometimes may look clearer to the reader what
the partial application tries to do.</p>
</div>
<div class="listingblock">
<div class="title">Combining filters making a closure to return another closure</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Closure&lt;Boolean&gt; combineFilters(final Closure&lt;Boolean&gt;... filters) {
    return { Integer number -&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        filters*.call(number).every()
    }
}

void 'Combining filters with closure combination'() {
    given: 'a huge list of numbers'
        def numbers = (1..1000)
    and: 'composing filtering'
        def even = { it % 2 == 0 }
        def greaterThanHundred = { it &gt; 100 }
        def byCriteria = combineFilters(even, greaterThanHundred) <i class="conum" data-value="2"></i><b>(2)</b>
    when: 'applying several filters'
        def result = numbers.findAll(byCriteria).sum() <i class="conum" data-value="3"></i><b>(3)</b>
    then: 'we should get the expected result'
        result == 247950
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In just one call we are using the behavior of closures to set the filters we will be
using without having to use any Xcurry function</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Passing all filter we want to apply in order</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Filtering numbers</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Why can I do step number 1 ? Because the closure&#8217;s <strong>filter</strong> value is set when the closure is
declared with the references at that time.  Afterwards those values won&#8217;t change. Anyway I made sure
that couln&#8217;t happen because I declare <strong><em>filters</em></strong> as a <strong><em>final</em></strong> parameter.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_delegation_strategy">2.5. Delegation strategy</h3>
<div class="paragraph">
<p>Closures can use different strategies to resolve some property references and methods.
Before talking about strategies, and how to change the order of resolution,
there are some important concepts we must know up front.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Definition of every concept is taken from the Closure javadoc at
<a href="http://groovy.codehaus.org/api/groovy/lang/Closure.html" class="bare">http://groovy.codehaus.org/api/groovy/lang/Closure.html</a>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>delegate : the delegate Object to which method calls will
go which is typically the outer class when the closure is constructed</p>
</li>
<li>
<p>owner : the owner Object to which method calls will go which is
typically the outer class when the closure is constructed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I want you to notice how many times the word <strong>typically</strong> is used. Here it would
mean <strong><em>everything will happen this way if the default resolution strategy is used</em></strong></p>
</div>
<div class="paragraph">
<p>There are 4 different strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OWNER_FIRST : <strong>(default)</strong> With this resolveStrategy set the closure will attempt to
resolve property references and methods to the owner first,
then the delegate.</p>
</li>
<li>
<p>OWNER_ONLY : With this resolveStrategy set the closure will resolve property
references and methods to the owner only and not call the delegate at all.</p>
</li>
<li>
<p>DELEGATE_FIRST : With this resolveStrategy set the closure will attempt to
resolve property references and methods to the delegate first then the owner.</p>
</li>
<li>
<p>DELEGATE_ONLY : With this resolveStrategy set the closure will resolve
property references and methods to the delegate only and entirely bypass the owner</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Strategies definition have been taken from the Closure javadoc at
<a href="http://groovy.codehaus.org/api/groovy/lang/Closure.html" class="bare">http://groovy.codehaus.org/api/groovy/lang/Closure.html</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The basic idea here is that we can change the order of the resolution of property
references and methods. But before getting into detail of every one of them,
I would like to know what is the normal resolution behavior of a Closure.
In order to do that lets see this example:</p>
</div>
<div class="listingblock">
<div class="title">Lexical scope</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'default closure resolution'() {
    given: 'an instance of ClosureBehavior'
        def instance = new ClosureBehavior()
    expect: 'result to be two'
        instance.sum() == 6
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Lexical scope</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class ClosureBehavior {

    <i class="conum" data-value="3"></i><b>(3)</b>
    def a = 1
    def b = 0
    def c = 0

    def sum() {
        <i class="conum" data-value="2"></i><b>(2)</b>
        def b = 2

        Closure&lt;Integer&gt; cl = {
            <i class="conum" data-value="1"></i><b>(1)</b>
            c = 3
            a + b + c
        }

        return cl()
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It seems that the closure follows lexical scope:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First tries to resolve in the closure scope</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>then goes up, to the local scope</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>and finally goes up again until reaches the class instance scope</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But wait. I said default strategy was OWNER_FIRST then&#8230;&#8203; why some of the
variables are resolved by lexical scope ? Well I came up with the following
example to help me to understand how the variables are resolved. As you may
notice local variables always win vs strategies. Only global and
delegate scope can be influenced by changing the resolution strategy.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Resolution</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1st</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2nd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3th</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4th</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OWNER_FIRST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">local 2 closure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OWNER_ONLY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">local 2 closure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">global</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELEGATE_FIRST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">local 2 closure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">global</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELEGATE_ONLY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">local 2 closure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>With this table as a cheatsheet I&#8217;m going to do some examples of all
strategies listed before.</p>
</div>
<div class="sect3">
<h4 id="_owner_first">2.5.1. OWNER FIRST</h4>
<div class="paragraph">
<p>(TODO)</p>
</div>
</div>
<div class="sect3">
<h4 id="_owner_only">2.5.2. OWNER_ONLY</h4>
<div class="paragraph">
<p>(TODO)</p>
</div>
</div>
<div class="sect3">
<h4 id="_delegate_first">2.5.3. DELEGATE FIRST</h4>
<div class="paragraph">
<p>(TODO)</p>
</div>
</div>
<div class="sect3">
<h4 id="_delegate_owner">2.5.4. DELEGATE_OWNER</h4>
<div class="paragraph">
<p>(TODO)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_memoization">2.6. Memoization</h3>
<div class="paragraph">
<p>Although memoization is normally used for recursive calculations&#8230;&#8203;
don&#8217;t worry, this chapter doesn&#8217;t start with "yet another Fibonacci example".</p>
</div>
<div class="paragraph">
<p>We&#8217;ll get there, but I think is easier to think about memoization as a form
of caching. A very simple one but caching nevertheless.</p>
</div>
<div class="paragraph">
<p>Imagine a very simple scenario. I would like a very simple cache to save
n calls to&#8230;&#8203;database/network/&#8230;&#8203;etc and it&#8217;s so simple I would waste my
time to use any fancy cache system.</p>
</div>
<div class="paragraph">
<p>In this first example, I&#8217;m simulating a way of getting users from a UserService
class with a method findUserById returning users having the id passed as parameter.</p>
</div>
<div class="paragraph">
<p>Because I know memory is far more than the memory need to store all users in
the given process, and because every call to that method really consumes a lot
of time, I&#8217;ve decided to memoize it.</p>
</div>
<div class="listingblock">
<div class="title">Memoized method</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@groovy.transform.Memoized
   def findUserDataById(Integer userId) {
        println "Getting user [$userId] data"

        return [id: userId, name: "john doe $userId", timestamp: System.currentTimeMillis()]
   }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to cache the method invocation I annotated the method with the annotation
groovy.transform.Memoize which creates a new cache at instance level.</p>
</div>
<div class="listingblock">
<div class="title">Memoized method</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Using memoize for a given method'() {
    given: 'a invocation to get a user'
        def result = findUserDataById(1)
    and: 'waiting to check timestamp later'
        Thread.sleep(500)
    when: 'asking again for the same user'
        result = findUserDataById(1)
    then: 'if cache is expected timestamp should match'
        result.timestamp == old(result.timestamp)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This was an easy way of turning an existing method to a method with an "extra" cache.
But what if we wanted to use a closure with the same feature.</p>
</div>
<div class="paragraph">
<p>Imagine we want to create a MD5 signature of every of a given list. It&#8217;s
clear same word will become the same hash, so why bothering doing the calculation
if we already know the outcome ?</p>
</div>
<div class="listingblock">
<div class="title">Memoized closure</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Using a memoized closure'() {
     given: 'a list of words'
         def words = [\
             'car','peter','maggie',
             'ronnie','book','peter',
             'road','car','ronnie'
         ]
     and: 'building the memoized closure'
         def md5fromWord = { String word -&gt;
             println "Word: $word" <i class="conum" data-value="1"></i><b>(1)</b>
             java.security.MessageDigest
                 .getInstance("MD5")
                 .digest(word.getBytes("UTF-8"))
                 .encodeHex()
                 .toString()
         }.memoize() <i class="conum" data-value="2"></i><b>(2)</b>
     when: 'collecting their md5 hashes'
         def md5Hashes = words.collect(md5fromWord) <i class="conum" data-value="3"></i><b>(3)</b>
     then: 'checking figures'
         md5Hashes.size() == 9
         md5Hashes.unique().size() == 6
     // Word: car
     // Word: peter
     // Word: maggie
     // Word: ronnie
     // Word: book
     // Word: road
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I will be printing every word to notice that, at some point, some of the
invocation will be omitted.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In order to create a cache-included-closure we need to call memoized()
method from Closure class and most important, use the closure returned by
that method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then we can use that closure in a more efficient way :)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_trampoline">2.7. Trampoline</h3>
<div class="paragraph">
<p>When writing recursive code, sometimes we can overflow the size of the stack and get and
Stackoverflow exception. To prevent that situation, Groovy gives us two solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Closure&#8217;s <strong><em>trampoline()</em></strong> method</p>
</li>
<li>
<p><strong><em>@TailRecursion</em></strong> AST transformation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A good example is to try to add up a list of numbers recursively.</p>
</div>
<div class="listingblock">
<div class="title">Recursion with trampoline()</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Trampoline: Adding up numbers recursively'() {
    given: 'a closure prepared to call itself recursively'
        def sumRecursively <i class="conum" data-value="1"></i><b>(1)</b>
        sumRecursively = { List&lt;Integer&gt; numbers, aggregator = 0 -&gt;
            if (!numbers) {
                return aggregator
            } else {
                sumRecursively.trampoline( <i class="conum" data-value="2"></i><b>(2)</b>
                        numbers.tail(),
                        aggregator + numbers.head())
            }
        }
    when: 'usisng the transformed version of closure'
        sumRecursively = sumRecursively.trampoline() <i class="conum" data-value="3"></i><b>(3)</b>
        def result = sumRecursively(1..10000)
    then: 'we should get the result without the stackoverflow exception'
        result == 50005000
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We need to declare sumRecursively and then attach its behabior to the actual variable</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Within the function every time we make a recursive call we must call to the "trampoline"
version of the function</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Finally to init the whole process execute a "trampoline" version of the closure</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It works ok but it seems a little bit complicated. Get a version with trampoline()
then not forget to call trampoline with arguments&#8230;&#8203;mmmmm</p>
</div>
<div class="paragraph">
<p><strong><em>@TailRecursive</em></strong> transformation helps you to avoid dealing with that kind of details.
You just focus on the implementation and it handles how to make the function to a
recursive one. This AST transformation is avaiable since version 2.3 of Groovy.</p>
</div>
<div class="paragraph">
<p>The only requirement here is to put the recursive call as the last expression in the
method body (at the tail, that&#8217;s why it&#8217;s called tail recursion optimization).</p>
</div>
<div class="listingblock">
<div class="title">Recursion with @TailRecursive</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@groovy.transform.TailRecursive
Integer recursiveSum(List&lt;Integer&gt; numbers, Integer aggregator = 0) {
    if (!numbers) {
        return aggregator
    } else {
        return recursiveSum(
            numbers.tail(),
            numbers.head() + aggregator
        )
    }
}

void 'TailRecursive: recursive sum'() {
    when: 'using the transformed method'
        def result = recursiveSum(1..10000)
    then: 'we should get the result without the stackoverflow exception'
        result == 50005000
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functional_interface_coercion">2.8. Functional interface coercion</h3>
<div class="paragraph">
<p>How do we used to pass filtering behavior to a collection if we didn&#8217;t have closures ? I&#8217;d started
by declaring an interface declaring the intent of the filter:</p>
</div>
<div class="listingblock">
<div class="title">Filter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

interface Filter&lt;T&gt; {
   Boolean accept(T element)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then of course an implementation:</p>
</div>
<div class="listingblock">
<div class="title">Filter implementation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

class EvenNumbersFilter implements Filter&lt;Integer&gt; {
    Boolean accept(Integer number) {
        return number % 2 == 0
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it. We can now use it:</p>
</div>
<div class="listingblock">
<div class="title">How to use the functional interface</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">List&lt;Integer&gt; filterNumbersByFilter(List&lt;Integer&gt; numbers, Filter&lt;Integer&gt; filter) {
    List&lt;Integer&gt; resultList = new ArrayList()

    for (Integer number : numbers) {
        if (filter.accept(number)) {
            resultList.add(number)
        }
    }

    return resultList
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">How to use the functional interface</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Functional Interface: the old fashioned way'() {
    given: 'a list of numbers'
        def numbers = (0..10)
    when: 'filtering using the class wrapping the filtering behavior'
        def evenNumbers = filterNumbersByFilter(numbers, new EvenNumbersFilter())
    then: 'We should get the expected result'
        evenNumbers == [0, 2, 4, 6, 8, 10]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now, how can we do the same in Groovy ? Well, in case we wanted to reuse the method receiving
the Filter instance we can use closures coercion:</p>
</div>
<div class="listingblock">
<div class="title">Closure coercion</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Functional Interface: closures coercion'() {
    given: 'a list of numbers'
        def numbers = (0..10)
    when: 'filtering using the class wrapping the filtering behavior'
        def filter = { it % 2 == 0 } as Filter <i class="conum" data-value="1"></i><b>(1)</b>
        def evenNumbers = filterNumbersByFilter(numbers, filter) <i class="conum" data-value="2"></i><b>(2)</b>
    then: 'We should get the expected result'
        evenNumbers == [0, 2, 4, 6, 8, 10]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creation of an instance that implements the functional interface. The body of the closure is
supposed to be the implementation of the only method that the interface had.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then you can use it whenever you used to pass an instance of that object</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_internal_vs_external_iteration">3. Internal Vs External iteration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of the time we need to iterate through a list, we end doing the same. We tend to specify every detail, we code
every step of the way. But is there any other way ? Well there is&#8230;&#8203;it&#8217;s call internal iteration.</p>
</div>
<div class="paragraph">
<p>The point here is that We should be taking care on the logic of filtering and transformation and not
how to loop through the collection, Don&#8217;t you thing ?</p>
</div>
<div class="paragraph">
<p>There are some reasons I would recommend you to start using internal iteration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Is more concise and clear</p>
</li>
<li>
<p>Reusability</p>
</li>
<li>
<p>Composition</p>
</li>
<li>
<p>Internal optimizations</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_more_concise">3.1. More concise</h3>
<div class="paragraph">
<p>Let&#8217;s say we have a list of mercenaries in lower case and we want to get their names in upper case. Well
no problem&#8230;&#8203;That is what is should look like in old-fashioned Java code:</p>
</div>
<div class="listingblock">
<div class="title">External Iteration: Java style</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'External iteration. Java like code'() {
    given: 'A collection we want to iterate'
        def expendables = ['Stallone', 'Staham', 'Couture']
    when: 'Collecting the upper case version of the names'
        def expendablesUpperCase = []
        for(String name: expendables) {
            expendablesUpperCase &lt;&lt; name.toUpperCase()
        }
    then: 'All names should be in upper case'
      expendablesUpperCase == ['STALLONE', 'STAHAM', 'COUTURE']
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>We have to remember to create the collection to store the transformed names.</p>
</li>
<li>
<p>Then we should know how the iteration is done</p>
</li>
<li>
<p>Finally to add explicitly every transformed name into the new collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maybe Groovy is more concise and less verbose&#8230;&#8203;hell yeah but you can do it wrong either.</p>
</div>
<div class="listingblock">
<div class="title">External Iteration: Groovy style</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'External iteration. Groovy style code'() {
    given: 'A collection we want to iterate'
        def expendables = ['Stallone', 'Staham', 'Couture']
    when: 'Collecting the upper case version of the names'
        def expendablesUpperCase = []
        expendables.each { name -&gt;
            expendablesUpperCase &lt;&lt; name.toUpperCase()
        }
    then: 'All names should be in upper case'
      expendablesUpperCase == ['STALLONE', 'STAHAM', 'COUTURE']
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>"That&#8217;s not what I signed for!!!"</em> you may think. Don&#8217;t worry Groovy has a lot more to offer. Collections
in Groovy have many useful method to loop through them filtering and collecting transformed values
without having to specify how a collection should be traversed.</p>
</div>
<div class="listingblock">
<div class="title">Internal Iteration: Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Internal iteration (I)'() {
    given: 'A collection we want to iterate'
        def expendables = ['Stallone', 'Staham', 'Couture']
        def upperCaseVersion = { String word -&gt; word.toUpperCase() }
    when: 'Collecting the upper case version of the names'
        def upperCaseExpendables = expendables.collect(upperCaseVersion)
    then: 'All names should be in upper case'
      upperCaseExpendables == ['STALLONE', 'STAHAM', 'COUTURE']
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows how you can loop through a collection in Groovy in a declarative way. You can almost
read <em>"I want to collect the upper-case-version of the expendable collection"</em> can&#8217;t you ?</p>
</div>
<div class="paragraph">
<p>Of course you can embed the closure expression as a parameter instead of declaring the expression and
then passing it to the collect method</p>
</div>
<div class="listingblock">
<div class="title">Internal Iteration: Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Internal iteration (II)'() {
    given: 'A collection we want to iterate'
        def expendables = ['Stallone', 'Staham', 'Couture']
    when: 'Collecting the upper case version of the names'
        def upperCaseVersion = expendables.collect { it.toUpperCase() }
    then: 'All names should be in upper case'
      upperCaseVersion == ['STALLONE', 'STAHAM', 'COUTURE']
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>But later on you&#8217;ll see that sometimes is better not to use the Closure expression directly if you
want to keep your code reusable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reusability">3.2. Reusability</h3>
<div class="paragraph">
<p>Imagine we had a method looping through a collection to sum all numbers less than 20.</p>
</div>
<div class="listingblock">
<div class="title">Internal Iteration: Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'external iteration: adding up all numbers from a given collection'() {
    given: 'a collection of numbers'
        def numbers = (0..1000)
        def sum = 0
    when: 'summing all of them'
        numbers.each { nextnumber -&gt;
            sum += nextnumber
        }
    then: 'the expected result should be the expected'
        sum == 500500
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we want to get all numbers from 20 to 100</p>
</div>
<div class="listingblock">
<div class="title">Internal Iteration: Groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'External iteration: Adding numbers from 20 to 100 from a given collection'() {
    given: 'a collection of numbers'
        def numbers = (0..1000)
        def sum = 0
    when: 'adding up all of them'
        numbers.each { nextnumber -&gt;
            if (nextnumber &gt; 20 &amp;&amp; nextnumber &lt; 100) {
                sum += nextnumber
            }
        }
    then: 'the expected result should be the expected'
        sum == 4740
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now&#8230;&#8203;you know what ? forget it :P</p>
</div>
<div class="paragraph">
<p>There should be a better way of refactoring this behavior. There are two main actions when trying to
solve these type of problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Filtering data</p>
</li>
<li>
<p>Transforming data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And when talking about Groovy and collections this means to use <strong><em>find</em></strong> or <strong><em>findAll</em></strong> when trying
to filtering data and <strong><em>collect</em></strong> for transforming data.</p>
</div>
<div class="paragraph">
<p>Back to the prolem, while the transformation applied to the data is the same the filtering applied
is different. Lets see how our reusable method should look like:</p>
</div>
<div class="listingblock">
<div class="title">Internal Iteration: Filter + Transformation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Integer sum(
    final Collection&lt;Integer&gt; source, <i class="conum" data-value="1"></i><b>(1)</b>
    final Closure&lt;Boolean&gt; filter = { it }) { <i class="conum" data-value="2"></i><b>(2)</b>

    return source.findAll(filter).sum() <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First we pass the collection we want to transform. We say transform deliberately, we don&#8217;t want
to <strong><em>mutate</em></strong> the collection but to create a new one for applying a given action. This case to sum
all numbers of that new collection</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We want to get certain numbers to add them up. By default if no filter given then apply to all (<strong><em>{ it }</em></strong>).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We&#8217;re using Groovy&#8217;s collection behavior to apply the given filter to get the new collection and
then sum all numbers in that collection.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And how to use it for different filters:</p>
</div>
<div class="listingblock">
<div class="title">Internal Iteration: Reuse of functions</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Internal iteration: Adding up with reusability'() {
    given: 'A collection of numbers'
        def numbers = (0..1000)
    when: 'adding up'
        def all = sum(numbers)
        def from20To100 = sum(numbers) {
            it &gt; 20 &amp;&amp; it &lt; 100
        }
    then: 'Results should be the expected'
        all == 500500
        from20To100 == 4740
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s great but the previous example shows us a way of reusing behavior through the use of methods.
But Does it mean it will be forcing us to create a method every time we would like to reuse a
certain behavior ? That would lead us to create a lot of methods don&#8217;t you think ?</p>
</div>
<div class="paragraph">
<p>Functional programming teach us that behavior is not limited to <strong><em>methods</em></strong> of an object. When
talking about behavior we will be talking of <strong><em>functions</em></strong> in a more general way.</p>
</div>
<div class="paragraph">
<p>Functions are more powertful in the way that they can be modified, passed as a parameter to other
functions, and still can be used as the methods we normally use. In Groovy such type of functions
are called <strong><em>closures</em></strong>.</p>
</div>
<div class="paragraph">
<p>Although we will be talking about <strong><em>closures</em></strong> deeper in its own chapter lets say for now that
they&#8217;re extremely useful to reuse behavior.</p>
</div>
<div class="paragraph">
<p>What if I want to use the same method with the same type of filter several times in the same
method. That would be a lot of boiler plate code. A lot of code to maintain and repeat. Sounds
too dirty&#8230;&#8203; and looks worst :P</p>
</div>
<div class="listingblock">
<div class="title">Internal Iteration: Reusability limited to methods ?</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Internal iteration: Reusability limited ? (I)'() {
    given: 'A collection of numbers'
        def numbers1 = [100, 20, 2, 54, 33, 14]
        def numbers2 = [100, 20, 2, 54, 33, 14]
        def numbers3 = [100, 24, 6, 48, 22, 40]
    when: 'adding up all numbers of first collection'
        def numbers1Sum = sum(numbers1)
    and: 'adding up numbers &gt; 20 and &lt; 100 for the remaining collections'
        def numbers2Sum = sum(numbers2) {
            it &gt; 20 &amp;&amp; it &lt; 100
        }
        def numbers3Sum = sum(numbers3) {
            it &gt; 20 &amp;&amp; it &lt; 100
        }
    then: 'Results should be the expected'
        numbers1Sum == 223
        numbers2Sum == 87
        numbers3Sum == 134
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>What can I do ? Well let&#8217;s say that Groovy methods could be transformed into <strong><em>closures</em></strong>&#8230;&#8203; How ?
As I said earlier <strong><em>functions</em></strong> / <strong><em>closures</em></strong> can be assigned and be passed as parameters.</p>
</div>
<div class="listingblock">
<div class="title">Internal Iteration: Reusability limited to methods ?</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Internal iteration: Reusability limited ? (II)'() {
    given: 'A collection of numbers'
        def numbers1 = [100, 20, 2, 54, 33, 14]
        def numbers2 = [100, 20, 2, 54, 33, 14]
        def numbers3 = [100, 24, 6, 48, 22, 40]
    and: 'A fixed type of filter'
        def greaterThan20LessThan100 = { it &gt; 20 &amp;&amp; it &lt; 100} <i class="conum" data-value="1"></i><b>(1)</b>
    when: 'adding up all numbers of first collection'
        def numbers1Sum = sum(numbers1)
    and: 'adding up numbers &gt; 20 and &lt; 100 for the remaining collections'
        def numbers2Sum = sum(numbers2, greaterThan20LessThan100) <i class="conum" data-value="2"></i><b>(2)</b>
        def numbers3Sum = sum(numbers3, greaterThan20LessThan100)
    then: 'Results should be the expected'
        numbers1Sum == 223
        numbers2Sum == 87
        numbers3Sum == 134
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We assign the closure representing the <strong><em>filter</em></strong> to a given variable</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we pass the closure as parameter to filter numbers</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And also I said <strong><em>methods</em></strong> in Groovy can be transformed to closures:</p>
</div>
<div class="listingblock">
<div class="title">Internal Iteration: Reusability limited to methods ?</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Internal iteration: Reusability limited ?'() {
    given: 'A collection of numbers'
        def numbers1 = [100, 20, 2, 54, 33, 14]
        def numbers2 = [100, 20, 2, 54, 33, 14]
        def numbers3 = [100, 24, 6, 48, 22, 40]
    and: 'A fixed type of behavior'
        def customSum = this.&amp;sum.rcurry { it &gt; 20 &amp;&amp; it &lt; 100} <i class="conum" data-value="1"></i><b>(1)</b>
    when: 'adding up all numbers of first collection'
        def numbers1Sum = sum(numbers1)
    and: 'adding up numbers &gt; 20 and &lt; 100 for the remaining collections'
        def numbers2Sum = customSum(numbers2) <i class="conum" data-value="2"></i><b>(2)</b>
        def numbers3Sum = customSum(numbers3)
    then: 'Results should be the expected'
        numbers1Sum == 223
        numbers2Sum == 87
        numbers3Sum == 134
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We are creating a new function with a fixed type of filter</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We have created a new function that sums all numbers greater than 20
and less than 200 for the collection passed as parameter</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If the expression <strong><em>this.&amp;sum.rcurry</em></strong> sounds like chinese to you just take that this
expression is only saying: I want to get a new function with the first parameter from the right with
the following value <strong><em>{ it &gt; 20 &amp;&amp; it &lt; 100}</em></strong>. Anyway I recommend you to review the chaper
dedicated to closures.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_composition_2">3.3. Composition</h3>
<div class="paragraph">
<p>Today&#8217;s specifications may change. Lets say I want to trim all strings coming from a given
collection. But then my boss comes and tells me he wants all words uppercase.</p>
</div>
<div class="listingblock">
<div class="title">Looping more than neccessary</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Specifications change. Looping Twice'() {
    given: 'a list of words'
        def words = [' animal', ' person', 'something else ']
    and: 'a couple of transformations'
        def trim = { it.trim() }
        def toUpperCase = { it.toUpperCase() }
    when: 'applying transformations one after another'
        def result =
            words
                .collect(trim) <i class="conum" data-value="1"></i><b>(1)</b>
                .collect(toUpperCase) <i class="conum" data-value="2"></i><b>(2)</b>
    then: 'we should get a cleaned list of words'
        result == ['ANIMAL', 'PERSON', 'SOMETHING ELSE']
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem is that we&#8217;re looping the word list twice</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>first to trim all words and then</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>we&#8217;re looping again to convert every word to uppercase.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With composing both behaviors we can apply both at once for every word. We will be saving
a loop for every new transformation. That&#8217;s worth knowing right ?</p>
</div>
<div class="listingblock">
<div class="title">Composing behavior</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Specifications change. Composition'() {
    given: 'a list of words'
        def words = [' animal', ' person', 'something else ']
    and: 'a couple of transformations'
        def trim = { it.trim() }
        def toUpperCase = { it.toUpperCase() }
        def trimAndUpperCase = toUpperCase &lt;&lt; trim <i class="conum" data-value="1"></i><b>(1)</b>
    when: 'applying transformations one after another'
        def result = words.collect(trimAndUpperCase)
    then: 'we should get a cleaned list of words'
        result == ['ANIMAL', 'PERSON', 'SOMETHING ELSE']
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a special notation for composing closures. The composition has to be read from right
to left. The first behavior to be taken is the first on the right.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_streams">4. Streams</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far, we&#8217;ve seen that in Groovy, filtering elements and applying transformation over
that collection is as easy as a pie right ? But we didn&#8217;t realize we could be more
efficient in the way we do those tasks.</p>
</div>
<div class="sect2">
<h3 id="_mind_the_lazyness">4.1. Mind the lazyness</h3>
<div class="paragraph">
<p>Imagine we want to filter even numbers from a given collection and then multiply them
10 times.</p>
</div>
<div class="listingblock">
<div class="title">Working more than you should</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Multiply even numbers 10 times'() {
    given: 'A collection of numbers'
        def numbers = (0..10)
    when: 'Filtering and transforming numbers'
        def result =
            numbers
                .findAll { it % 2 == 0} <i class="conum" data-value="1"></i><b>(1)</b>
                .collect { it * 10 } <i class="conum" data-value="2"></i><b>(2)</b>
                .collect { it + 1 } <i class="conum" data-value="3"></i><b>(3)</b>
    then: 'We should get the expected result'
        result == [1, 21, 41, 61, 81, 101]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We loop through the entire collection to get all required values</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we loop through the filtered values to apply some transformation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then we loop one more time to apply another transformation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s clear we should be able to loop only once the collection while applying the transformation only
to the required values. In this particular example is not critical, but imagine we were looping a collection with thousands
of elements, going through that collection more than once wouldn&#8217;t be very nice so to speak.</p>
</div>
<div class="paragraph">
<p>Let see what says the wikipedia about streams in this context:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&#8230;&#8203;A stream is a lazily evaluated or delayed sequence of data elements. A stream can be used
similarly to a list, but later elements are only calculated when needed. Streams can therefore
represent infinite sequences and series.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Wikipedia
</div>
</div>
<div class="paragraph">
<p>So how can we modify previous example to make it process the required values on the fly, as
soon as the process detectes they are suitable to be part of the result ?</p>
</div>
<div class="paragraph">
<p>If we only wanted to combine transformations we could have done something like this:</p>
</div>
<div class="listingblock">
<div class="title">Combine transformations</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Multiply even numbers 10 times'() {
    given: 'A collection of numbers'
        def numbers = (0..10)
        def multiplyTenTimes = { x -&gt; x * 10}
        def byEvenNumber = { x -&gt; x % 2 == 0 }
        def plusOne = { x -&gt; x + 1 }
    when: 'Filtering and transforming numbers'
        def result =
            numbers
                .findAll(byEvenNumber) <i class="conum" data-value="1"></i><b>(1)</b>
                .collect(multiplyTenTimes &gt;&gt; plusOne) <i class="conum" data-value="2"></i><b>(2)</b>
    then: 'We should get the expected result'
        result == [1, 21, 41, 61, 81, 101]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok, but now I would like one step futher and apply filters and transformations per each item in the list.</p>
</div>
<div class="paragraph">
<p>Although later on we&#8217;ll be seeing there&#8217;re at least a couple libraries that can do it for you in a
easy way. But for now we have to make do with Groovy alone.</p>
</div>
<div class="listingblock">
<div class="title">Two tasks at once</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Multiply even numbers 10 times lazily'() {
    given: 'A collection of numbers'
        def emptyList = []
        def numbers = (0..10)
        def multiplyTenTimes = { x -&gt; x * 10}
        def byEvenNumber = { x -&gt; x % 2 == 0 }
        def plusOne = { x -&gt; x + 1 }
    when: 'Filtering and transforming numbers'
        def result =
            numbers.inject(emptyList) { acc, val -&gt;
                if (val % 2 == 0) {
                    acc &lt;&lt; plusOne(multiplyTenTimes(val))
                }
                acc
            }
    then: 'We should get the expected result'
        result == [1, 21, 41, 61, 81, 101]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have use the collection <strong><em>inject</em></strong> method. This method receives two arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Initial value of the aggregated data</p>
</li>
<li>
<p>A closure receiving two parameters: the <strong><em>agregated data</em></strong>, and the <strong><em>next value</em></strong> of the source collection</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now the process declares which element the transformation has to be applied to and then add it to
the result. We don&#8217;t have to loop the collection twice we are doing both filtering and
transformation all at once.</p>
</div>
<div class="paragraph">
<p>Now we reached the goal, the process is more efficient but the problem is that I don&#8217;t like the
code, it&#8217;s not reusable.  So it&#8217;s time to change it.</p>
</div>
<div class="paragraph">
<p>I&#8217;ve based my implementation in the JDK8 Stream API. Of course this is a very basic implementation,
but it shows how lazy evaluation could be implemented.</p>
</div>
<div class="listingblock">
<div class="title">Simple Stream</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.streams

final class Stream {

    final Collection&lt;?&gt; col
    Closure&lt;Boolean&gt; filter
    Closure&lt;?&gt; transformer
    Integer howMany

    Stream(Collection&lt;?&gt; col) {
       this.col = col
    }

    static Stream from(Collection&lt;?&gt; source) {
        return new Stream(source)
    }

    Stream filter(Closure&lt;Boolean&gt; filter) {
        this.filter = filter
        this
    }

    Stream map(Closure&lt;?&gt; transformer) {
        this.transformer = transformer
        this
    }

    Stream take(Integer howMany) {
        this.howMany = howMany
        this
    }

    Collection&lt;?&gt; collect() {
        def result = []

        col.takeWhile { val -&gt;
            if (filter(val)) {
                result &lt;&lt; transformer(val)
            }
            howMany ? (result.size() &lt; howMany) : true
        }

        return result
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the code initializes both the filter and transformer of the collection. But the interesting
part is in the <strong><em>collect()</em></strong> method:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The filter is applied to any element. If the element is suitable to be added to the result then&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The transformation is applied to the element, and finally the element is added to the result.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now if we change our test code, it should look like the following:</p>
</div>
<div class="listingblock">
<div class="title">Functional lazy</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Multiply even numbers 10 times lazily (nicer way)'() {
    given: 'A collection of numbers'
        def numbers = (0..10)
        def multiplyTenTimes = { x -&gt; x * 10}
        def byEvenNumber = { x -&gt; x % 2 == 0 }
        def plusOne = { x -&gt; x + 1 }
    when: 'Filtering and transforming numbers'
        def result =
            Stream
                .from(numbers)
                .filter(byEvenNumber)
                .map(multiplyTenTimes &gt;&gt; plusOne)
                .take(2)
                .collect()
    then: 'We should get the expected result'
        result == [1, 21]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that even though I could be possibly looping through a huge number of items,
I&#8217;m only processing the minimum possible amount.</p>
</div>
<div class="paragraph">
<p>Although there is a method in Groovy called <strong>take(Integer)</strong> which can be used to get a certain
number of items from a given collection/iterable/iterator as far as I know it can&#8217;t be used
for an infinite collection.</p>
</div>
</div>
<div class="sect2">
<h3 id="_stream_groovy">4.2. stream-groovy</h3>
<div class="paragraph">
<p>It&#8217;s great to know to understand how to build lazy estructures, but it&#8217;s even better to use
libraries already created to do that work for you.</p>
</div>
<div class="paragraph">
<p><strong><em>Tim Yate&#8217;s</em></strong> <a href="http://timyates.github.io/groovy-stream/"><strong><em>stream-groovy</em></strong></a> is one of the libraries I will be reviewing in this chapter.
What&#8217;s this library for ?</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Groovy-stream is a library for Groovy that lets you create lazy Iterators (or streams) based on
Iterators, Collections, Maps, Iterables or other Streams.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; stream-groovy site
</div>
</div>
<div class="paragraph">
<p>Earlier I built a simple class that helped me to loop through a collection and filter data while
applying a single transformer. In other words I was able to create a stream for a single data set
and apply a single filter and transformer to the required values.</p>
</div>
<div class="paragraph">
<p>It was nice for that case but with many limitations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What if I want to combine <strong><em>more than one stream</em></strong> ?</p>
</li>
<li>
<p>What if I want to combine <strong><em>more than one filter</em></strong> ?</p>
</li>
<li>
<p>What if I want to combine <strong><em>more than one transfomer</em></strong> ?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instead of reinventing the wheel lets see how <strong><em>stream-groovy</em></strong> can help you to do that.</p>
</div>
<div class="sect3">
<h4 id="_first_steps">4.2.1. First steps</h4>
<div class="listingblock">
<div class="title">stream-groovy getting started</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Getting double values from even numbers of a given collection'() {
    when: 'Processing the stream'
        def result =
            Stream.
                from(0..5). <i class="conum" data-value="1"></i><b>(1)</b>
                filter { it % 2 == 0 }. <i class="conum" data-value="2"></i><b>(2)</b>
                map { it * 10 }. <i class="conum" data-value="3"></i><b>(3)</b>
                collect() <i class="conum" data-value="4"></i><b>(4)</b>
    then: 'We should get the expected results'
        result == [0, 20, 40]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example looks pretty similar to example in the previus chapter right ? Busted!!! ;)</p>
</div>
<div class="paragraph">
<p>I&#8217;d like to point out some important parts:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We want to loop through a <strong><em>stream</em></strong>. A <strong><em>stream</em></strong> could be created using the different
overloaded versions of the <strong><em>from</em></strong> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Filtering the stream, and processing only the
values matching this expression. You will chose what elements to process thanks to the <strong><em>filter</em></strong>
method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We&#8217;re applying a transformation. This time I want to get 10 times of every element in
the stream. You will normally use <strong><em>map</em></strong> to express a transformation.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Eventually I would like
to get the transformated data. Because the result of the transformation is an instance of Iterable I
can use methods such as collect(), next(), find(), findAll()</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_stream">4.3. Creating a Stream</h3>
<div class="paragraph">
<p>As I mentioned in the previous chapter your can start creating a stream using the method
<strong><em>Stream.from()</em></strong></p>
</div>
<div class="listingblock">
<div class="title">stream-groovy getting started</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Creating streams'() {
    when: 'building streams from collections and iterables'
        def stream1 = Stream.from({ x++ }).using(x: 1) <i class="conum" data-value="1"></i><b>(1)</b>
        def stream2 = Stream.from([1, 2, 3]) <i class="conum" data-value="2"></i><b>(2)</b>
        def stream3 = Stream.from(50..100) <i class="conum" data-value="3"></i><b>(3)</b>
        def stream4 = Stream.from(x: 0..2, y: 4..2) <i class="conum" data-value="4"></i><b>(4)</b>
    and: 'from an iterator instance'
        def x = 0
        def iterator = [hasNext: { true }, next: { x++ }] as Iterator
        def stream5 = Stream.from(iterator) <i class="conum" data-value="5"></i><b>(5)</b>
    and: 'also from another stream'
        def stream6 = Stream.from(stream1) <i class="conum" data-value="6"></i><b>(6)</b>
    then: 'values generated by the stream invocations'
        stream1.take(2).collect() == [1, 2]
        stream2.take(2).collect() == [1, 2]
        stream3.take(4).collect() == [50, 51, 52, 53]
        stream4.take(2).collect() == [[x:0, y:4], [x:0, y:3]]
    and: 'using until instead of take'
        stream5.until{ it &gt; 3}.collect() == [0, 1, 2, 3]
        stream6.until{ it &gt; 6}.collect() == [3, 4, 5, 6]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In general you can create a stream from an iterable instance such as collections, or any class
implementing java.util.Iterable, or creating a generator with the following expression:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Beware of not limiting the number of elements you want to receive from a generator.
You might be creating a infinite loop!!!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_nba_time">4.4. NBA time</h3>
<div class="paragraph">
<p>This year I talked about functional programming at the Greach conference in Madrid and most of the
examples were about NBA games.</p>
</div>
<div class="paragraph">
<p>One of the examples were about getting the maximum difference in an NBA game of all times. I started
from an imperative style code, and then I was moving until getting a decent functional sample.</p>
</div>
<div class="paragraph">
<p>However I think I didn&#8217;t show how a lazy stream could beat the last example. Well it&#8217;s about time!!</p>
</div>
<div class="listingblock">
<div class="title">Non lazy approach</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Maximum difference in an NBA game: non lazy'() {
    when: 'Csv iterable'
        def result = csv
                .findAll(byDateFunction)
                .collect(differenceFunction)
                .max()
    then: 'The result should be the expected'
        result == 45
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the lazy counterpart:</p>
</div>
<div class="listingblock">
<div class="title">Lazy approach</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Maximum difference in an NBA game: lazy'() {
    when: 'Csv iterable'
        def result =
            Stream
                .from(csv)
                .filter(byDateFunction)
                .map(differenceFunction)
                .max()
    then: 'The result should be the expected'
        result == 45
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ve used the same functions for filtering data and calculating the difference in every game for
both examples.</p>
</div>
<div class="listingblock">
<div class="title">Filter</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def getByDateFunction() {
    return { row -&gt;
       row.date.endsWith('2013')
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Transformation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def getDifferenceFunction() {
    return { row -&gt;
        [row.homePoints, row.visitorPoints]*.
            toInteger().
            sort().
            with {
                last() - first()
            }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Altough this time I didn&#8217;t use the whole NBA data set, however results are clear, the non lazy
approach took more than twice as long as the lazy code.</p>
</div>
<div class="paragraph">
<p>So next time you think about lazyness&#8230;&#8203;.well just keep this in mind&#8230;&#8203;  maybe is not that bad after
all.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_immutability">5. Immutability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(TODO)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_oop_revisited">6. OOP Revisited</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of the time is hard to think in terms of functional programming because we are not used to do
it. I was born as an OOP programmer, and it&#8217;s now when I&#8217;ve started digging into
functional programming.</p>
</div>
<div class="paragraph">
<p>So I guess that a friendly way of travelling to the functional land would be to pass through some of
the object-oriented places we&#8217;ve been working on for the past 20 years. Do you want to join me in
this trip ? Lets go!</p>
</div>
<div class="paragraph">
<p>I&#8217;ve followed the list of oop patterns discussed in the book "Functional Programming Patterns" by
Michael Bevilaqua-Linn.</p>
</div>
<div class="paragraph">
<p>Object oriented languages that doesn&#8217;t have functions as first citizens have to make do with classes
and methods in order to be able to pass behavior to another classes or methods.</p>
</div>
<div class="sect2">
<h3 id="_state">6.1. State</h3>
<div class="paragraph">
<p>Closures have an important characteristic, which is they capture the "state" of the scope where they
were created.</p>
</div>
<div class="paragraph">
<p>IMHO the wrong way of thinking about this topic is the following example, which mutates
one of the references the closure is using.</p>
</div>
<div class="listingblock">
<div class="title">State (Wrong)</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'State: using state wrong (I)'() {
    given: 'an object used in a closure'
        def state = new State(discount:50) <i class="conum" data-value="1"></i><b>(1)</b>
        def closure = { price -&gt;
            price * (state.discount / 100) <i class="conum" data-value="2"></i><b>(2)</b>
        }
    when: 'calculating the price discount'
        def result1 = closure(100)
    and: 'changing state value'
        state = new State(discount:20) <i class="conum" data-value="3"></i><b>(3)</b>
        def result2 = closure(100)
    then: 'the second result is different'
        result1 != result2
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We declare a given discount to apply to some prices.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The scope is so wide there is the risk someone could mutate the state reference value</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The worst happened. We mutated state and the result of calling the closure with the same
value changes. If you care about mutability, this is not good.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>How can we pass state without mutating references used by our closure. I&#8217;ve changed the
example a little bit:</p>
</div>
<div class="listingblock">
<div class="title">State</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'State: using state wrong (II)'() {
    given: 'an object used in a closure'
        def state = new State(discount:50) <i class="conum" data-value="1"></i><b>(1)</b>
    and: 'reducing the closure avaiable scope when is created'
        def closure = { State st -&gt; <i class="conum" data-value="2"></i><b>(2)</b>
            return { price -&gt;
                price * (st.discount / 100)
            }
        }
    when: 'calculating the price discount'
        def closureWithImmutableState  = closure(state)
        def result1 = closureWithImmutableState(100)
    and: 'changing state value'
        state = new State(discount:20) <i class="conum" data-value="3"></i><b>(3)</b>
        def result2 = closureWithImmutableState(100)
    then: 'the second result is different'
        result1 == result2
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We declare the state at a given point</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We declare the closure, but notice that when the inner closure is created it only sees the
state when it was created nothing more.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>That&#8217;s way when the state variable mutates the execution of the closure remains the same</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_command">6.2. Command</h3>
<div class="paragraph">
<p>Command pattern normally wraps a certain behavior, and that behavior is passed to another function
or object to execute that behavior with the data found at the destination function or object.</p>
</div>
<div class="paragraph">
<p>Imagine I want to purchase online two tickets, and I can chose between paying the VIP tickets or the
regular ones. Depending on my choice the payment process will charge me differently.</p>
</div>
<div class="listingblock">
<div class="title">Object receiving command</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

class PurchaseEntry {

    BigDecimal price

    BigDecimal applyPurchaseProcess(PurchaseProcess process) {
        return process.calculate(price)
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The purchase order has the normal price of the purchase, and depending on the process applied, the
final amount could be changed.</p>
</div>
<div class="listingblock">
<div class="title">Contract of the command</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

interface PurchaseProcess {
    BigDecimal calculate(BigDecimal price)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All processes passed to the process entry, should comply to the PurchaseProcess interface. Remember
we can create a closure and coerce it to become a functional interface.</p>
</div>
<div class="listingblock">
<div class="title">Using command pattern</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Command: passing behavior to another class'() {
    given: 'a given purchase has a certain price'
        def purchaseEntry = new PurchaseEntry(price: 200) <i class="conum" data-value="1"></i><b>(1)</b>
    when: 'two different purchase processes'
        def result = purchaseEntry.applyPurchaseProcess(process) <i class="conum" data-value="2"></i><b>(2)</b>
    then: 'the price is the expected depending on the process'
        result == expectedPrice
    where: 'possible processes are'
        process                           | expectedPrice
        { price -&gt; price }                | 200 <i class="conum" data-value="3"></i><b>(3)</b>
        { price -&gt; price += price * 0.3 } | 260 <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initializing the entry with the initial price</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Applying each of the processes to check different values</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Declaring each process and the expected prices after applying those processes to the entry</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_immutable_objects_instead_of_builder">6.3. Immutable objects instead of Builder</h3>
<div class="paragraph">
<p>Six years ago I remember creating builder objects in Java not only because I was preserving
immutability (I didn&#8217;t care about it at that time) but also because using a builder with a fluent
API (using the chain pattern of course) was like using a DSL.</p>
</div>
<div class="paragraph">
<p>Nowadays with Groovy both of those "requirements" can be achieved by using the @Immutable
transformation and the fact that you can use maps when building new instances of an object.</p>
</div>
<div class="paragraph">
<p>We want to build and immutable object, or an object as immutable as it could be. Our object
carries information about a given video. Here is the Java-Style builder.</p>
</div>
<div class="listingblock">
<div class="title">Video</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

import groovy.transform.TupleConstructor

@TupleConstructor
class Video {
    String name
    String type
    long length

    void setName(String name) {}
    void setType(String type) {}
    void setLength(Long length) {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to make Video object immutable (and not using @Immutable as we will see later on) I came
with this idea of forcing to create all possible constructors to be able to initialize class fields
using constructors and then overriding the setters.</p>
</div>
<div class="paragraph">
<p>I guess it would be easier if we could declare fields as private and Groovy would care about private
but so far it doesn&#8217;t. So even if the field is private you can access to it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even in Java through the Reflection API you can access to the value of a private field.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next is the builder itself. It has a fluent API so if you use an IDE you will be please about
concatenating builder methods to initialize and build a new instance of Video class.</p>
</div>
<div class="listingblock">
<div class="title">Video Builder</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

class VideoBuilder {

    String name
    String type
    Long length

    static VideoBuilder builder() {
        return new VideoBuilder()
    }

    VideoBuilder name(String name) {
        this.name = name
        return this
    }

    VideoBuilder type(String type) {
        this.name = name
        return this
    }

    VideoBuilder length(Long length) {
        this.length = length
        return this
    }

    Video build() {
        return new Video(name, type, length)
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally both classes interact together in the following specification.</p>
</div>
<div class="listingblock">
<div class="title">Using builder</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Immutability through Builder'() {
    given: 'an object built by a builder'
        def video =
            VideoBuilder
                .builder()
                .name('trip.avi')
                .type('mp4')
                .length(100000)
                .build()
    when: 'trying to mutate the object'
        video.name = 'anothervideo'
    then: 'the instance should not have been mutated'
        video.name == 'trip.avi'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a lot of code right ? Since Groovy 1.7 <strong><em>@Immutable</em></strong> annotation is avaiable. This
annotation applies an AST transformation to make your classes almost immutable. To see the
particulars of what <strong><em>@Immutable</em></strong> can do for you, I&#8217;d recommend you to check the GroovyDoc, it&#8217;s
very detailed.</p>
</div>
<div class="listingblock">
<div class="title">ImmutableVideo</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

import groovy.transform.Immutable

@Immutable
class ImmutableVideo {
    String name
    String type
    long length
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Using @Immutable</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Immutability through @Immutable'() {
    given: 'an immutable instance'
        def video = new ImmutableVideo(
            name: 'video.mp4',
            type: 'mp4',
            length: 12434
        )
    when: 'trying to mutate the object'
        video.name = 'somethingelse.avi'
    then: 'an exception will be thrown'
        thrown(Exception)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The main difference between the Builder instance and the use of the @Immutable annotation is that
the use of the annotation will thrown an exception every time you try to access to any of the fields
of the anotated class, while the instance built with the builder will just ignore your attempts to
change the value of your fields.</p>
</div>
<div class="paragraph">
<p>Maybe there are more solutions to that problem, like a friend of mine says&#8230;&#8203;.pull-requests are
welcome :-)</p>
</div>
</div>
<div class="sect2">
<h3 id="_replacing_iterator">6.4. Replacing Iterator</h3>
<div class="paragraph">
<p>Most of the ideas about this topic have been already discussed in <a href="3_iteration.html">Internal vs External Iteration</a>.</p>
</div>
<div class="paragraph">
<p>The only idea I want to touch here is <strong><em>sequence comprehensions</em></strong>.</p>
</div>
<div class="paragraph">
<p>Why comprehensions are so appealling. Have you ever tried to loop through two collections at a time
to get values combined ? I&#8217;m sure you have. How did it look like ? I bet it was pretty much like this:</p>
</div>
<div class="listingblock">
<div class="title">Looping hell</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Looping two collections at the same time'() {
    given: 'two different collections'
        def collection1 = (10..12)
        def collection2 = (60..62)
    and: 'the collection combining the result'
        def combination = []
    when: 'combining both collections'
        collection1.each { outer -&gt;
            collection2.each { inner -&gt;
               combination &lt;&lt; [outer, inner]
            }
        }
    then: 'values should be the expected'
        combination == [
            [10, 60],
            [10, 61],
            [10, 62],
            [11, 60],
            [11, 61],
            [11, 62],
            [12, 60],
            [12, 61],
            [12, 62]
        ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately Groovy doesn&#8217;t have comprehensions inbuilt in the language. But good news you have
some options. You can use <strong><em>Tim Yates'</em></strong> <a href="http://timyates.github.io/groovy-stream/"><strong><em>stream-groovy</em></strong></a> library which have among others some
comprehensions implementation.</p>
</div>
<div class="listingblock">
<div class="title">stream-groovy comprehensions</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Groovy comprehensions using stream-groovy'() {
    given: 'two different collections'
        def collection1 = (10..12)
        def collection2 = (60..62)
    when: 'combining both collections using stream-groovy'
        def combination =
            Stream
                .from(x: collection1, y: collection2)
                .map { [x, y] }
                .collect()
    then: 'the results should be the expected'
        combination == [
            [10, 60],
            [10, 61],
            [10, 62],
            [11, 60],
            [11, 61],
            [11, 62],
            [12, 60],
            [12, 61],
            [12, 62]
        ]
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_template_pattern">6.5. Template pattern</h3>
<div class="paragraph">
<p>The intent of the template pattern is to describe a process skeleton in an abstract class and let
subclasses to implement the behavior of some parts of the process.</p>
</div>
<div class="paragraph">
<p>The example we&#8217;re using is an imaginary financial calculation. Imagine a bank that depending on its
clients applies a different values for some parts of the calculations&#8230;&#8203;weird right ?</p>
</div>
<div class="paragraph">
<p>Apart from the details the process is always the same adding up the amount,
the applied taxes and then possible extra costs.</p>
</div>
<div class="paragraph">
<p>First lets see how it would look like using a classical object oriented approach.</p>
</div>
<div class="listingblock">
<div class="title">Abstract class</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

abstract class AbstractFinancialProcess {

    abstract Double calculateTaxes(Double amount)
    abstract Double calculateExtras(Double amount)

    Double calculate(Double amount) {
        return amount +
            calculateTaxes(amount) +
            calculateExtras(amount)
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For good clients the bank doesn&#8217;t charge much:</p>
</div>
<div class="listingblock">
<div class="title">Soft financial calculation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

class FinancialProcessSoft extends AbstractFinancialProcess {

    Double calculateTaxes(Double amount) {
        return amount * 0.01
    }

    Double calculateExtras(Double amount) {
        return amount * 0.2
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For bad clients the picture doesn&#8217;t look that well:</p>
</div>
<div class="listingblock">
<div class="title">Hard financial calculation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package groovyfp.oop2fn

class FinancialProcessHard extends AbstractFinancialProcess {

    Double calculateTaxes(Double amount) {
        return amount * 0.10
    }

    Double calculateExtras(Double amount) {
        return amount * 0.5
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then of course testing the process with these two implementations:</p>
</div>
<div class="listingblock">
<div class="title">Template pattern object oriented approach</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Classical template method implementation'() {
    given: 'One concrete subclass implementation'
        def softCalculation = new FinancialProcessSoft()
    and: 'another different implementation based in the same parent'
        def hardCalculation = new FinancialProcessHard()
    expect: 'both results differ using the same process'
        softCalculation.calculate(100) !=
        hardCalculation.calculate(100)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So how to turn this pattern to a functional style of programming ?</p>
</div>
<div class="paragraph">
<p>Well the abstract class which represented the process could be translated to
a function (I meant a closure):</p>
</div>
<div class="listingblock">
<div class="title">Template now is a higher function</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Closure&lt;Double&gt; calculate = {
        Closure&lt;Double&gt; calculateTaxes,
        Closure&lt;Double&gt; calculateExtras,
        Double amount -&gt;

    return amount + calculateTaxes(amount) + calculateExtras(amount)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we can create functions to "fill" the implementation gaps of this process</p>
</div>
<div class="listingblock">
<div class="title">Specific details</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Closure&lt;Double&gt; calculateSoftTaxes = { Double amount -&gt;
    return amount * 0.01
}

Closure&lt;Double&gt; calculateSoftExtras = { Double amount -&gt;
    return amount * 0.2
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we use the functions to calculate the final amount:</p>
</div>
<div class="listingblock">
<div class="title">Using functional template pattern</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Template pattern using functions'() {
    when: 'calculating using predefined functions'
        def result1 =
            calculate(
                calculateSoftTaxes,
                calculateSoftExtras,
                100
            )
    and: 'calculating using anonymous functions'
        def result2 =
            calculate(
                { amount -&gt; amount * 0.2 },
                { amount -&gt; amount * 0.10 },
                100
            )
    then: 'same process...different results...with less code'
        result1 != result2
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because we&#8217;re using functions we can be more flexible about how to compose and reuse
different combinations of functions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By the way, in many of the examples variables are typed. This is intentional because I want
reader to know what the functions really return. Depending on the situation typing is really up to
you
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Building a reusable function on the fly</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Composing functions to reuse templates'() {
    when: 'building a preset calculation'
        Closure&lt;Double&gt; customCalculation = { Double amount -&gt;
            calculate(
                calculateSoftTaxes,
                calculateSoftExtras,
                amount
            )
        }
    then: 'you can reuse it along your code'
        customCalculation(100) == 121.0
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_strategy">6.6. Strategy</h3>
<div class="paragraph">
<p>The intent of this pattern is to declare a process that uses an algoritm that can be implemented in
several ways</p>
</div>
<div class="paragraph">
<p>Lets say we are working in a video cassette company (an we&#8217;re in the 90&#8217;s :P). We belong to the
quality department and we want to filter those videos not passing minimal standard validation. But
the problem is that depending on the country the minimal validation changes.</p>
</div>
<div class="listingblock">
<div class="title">Different strategies</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">List&lt;ImmutableVideo&gt; findAllFaultyVideo(List&lt;ImmutableVideo&gt; videoList, Closure&lt;Boolean&gt; validationStrategy) {
    return videoList
        .findAll(validationStrategy) <i class="conum" data-value="1"></i><b>(1)</b>
        .asImmutable() <i class="conum" data-value="2"></i><b>(2)</b>
}

Closure&lt;Boolean&gt; strategy1 = { ImmutableVideo video -&gt; video.type == 'mp4' } <i class="conum" data-value="3"></i><b>(3)</b>
Closure&lt;Boolean&gt; strategy2 = { ImmutableVideo video -&gt; video.length &lt; 700  } <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The validation strategy is applied to the collection filter</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Because we want to use good functional practices we dont want anybody to alter the result list</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The first strategy will detect as invalid mp4 videos</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The second strategy will detect as invalid videos with size less than 700 bytes</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Strategy test</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Changing the validation strategy'() {
    given:'A list of cars'
        List&lt;ImmutableVideo&gt; videoList = [
            [name: 'video1', type: 'avi', length: 1000],
            [name: 'video2', type: 'mp4', length: 1000],
            [name: 'video3', type: 'avi', length: 500] ,
            [name: 'video4', type: 'mp4', length: 1000],
            [name: 'video5', type: 'mp4', length: 50]
        ].asImmutable() as ImmutableVideo[]
    when: 'applying different strategies to the same list'
        def result1 = findAllFaultyVideo(videoList, strategy1)
        def result2 = findAllFaultyVideo(videoList, strategy2)
    then: 'you will have different result size'
        result1.size() == 3
        result2.size() == 2
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fighting_null_object">6.7. Fighting Null Object</h3>
<div class="paragraph">
<p>Null pointer exceptions are the plague of our era in computing programming. There are studies on how
many millions are wasted because of this problem.</p>
</div>
<div class="paragraph">
<p>Here I&#8217;m going to show you a couple solutions to tackle this problem:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Groovy truth</p>
</li>
<li>
<p>Optional pattern</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem of <strong><em>NullPointerException</em></strong> is not only the sad surprise of an exception during
runtime but also the amount of lines of code you have to spend to make your code <strong><em>"safe"</em></strong>.
There is a lot of boilerplate code involved.</p>
</div>
<div class="paragraph">
<p>I will use a really simple example to try to show the problem and the possible solutions to it.</p>
</div>
<div class="paragraph">
<p>We have a method to get the number of letters of a given word. You can pass a String or
unfortunately a null value.</p>
</div>
<div class="listingblock">
<div class="title">Null</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Integer countLetters(String name) {
    return name.length() <i class="conum" data-value="1"></i><b>(1)</b>
}

void 'Fighting NPE: Groovy truth (I)'() {
    given: 'A word'
        def word = null
    when: 'Invoking the method'
        def result = countLetters(word) <i class="conum" data-value="2"></i><b>(2)</b>
    then: 'A NPE will be thrown'
        thrown(NullPointerException)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The method calls to the lenght method of the value passed as parameter</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When the value of the variable passed as parameter is null the method will throw a NPE trying
to access a method from a null value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Although using the Groovy <strong><em>safe</em></strong> operator (<strong><em>?</em></strong>) is not the one-for-all solution. It is
a good starting point to avoid NPE problems.</p>
</div>
<div class="listingblock">
<div class="title">Groovy safe operator</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">Integer countLettersGroovyTruth(String name) {
    return name?.length() <i class="conum" data-value="1"></i><b>(1)</b>
}

void 'Fighting NPE: Groovy truth (II)'() {
    given: 'A word'
        def word = null
    when: 'Invoking the method'
        def result = countLettersGroovyTruth(word) <i class="conum" data-value="2"></i><b>(2)</b>
    then: 'No exception will be thrown'
        notThrown(NullPointerException)
    and: 'The method to return null'
        result == null
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mark the reference as safe.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When trying to access some methods, or fields from that object, Groovy wil check whether
the reference is null or not. In case it were null then the evaluation won&#8217;t go any further and
the expression will return null.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The null value in Groovy is not the null of Java. It&#8217;s backed by <strong><em>NullObject</em></strong>.</p>
</div>
<div class="listingblock">
<div class="title">Null is not what it seems</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Null is not null'() {
    expect: 'That null is not what it seems'
        null.getClass() == org.codehaus.groovy.runtime.NullObject
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This object helps us to apply one of the principals of the Groovy truth. So whenever we had
a null reference we can use it as a boolean value, which of course always will evaluate to
<strong><em>false</em></strong>.</p>
</div>
<div class="listingblock">
<div class="title">Groovy truth</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void isNullThis(anything) {
    if (!anything) {
        println "Is null"
    } else {
        println anything.class.simpleName
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Null as boolean</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void isNullThis(anything) {
    if (!anything) {
        println "Is null"
    } else {
        println anything.class.simpleName
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok, <strong><em>null</em></strong> is an instance of <strong><em>NullObject</em></strong>, so How this helps ? Well if you check out
the list of methods NullObject has you will figure out some things. The most remarkable is
that you don&#8217;t have to use safety when accessing collections.</p>
</div>
<div class="listingblock">
<div class="title">Collections are safe</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">List&lt;String&gt; doSomething(List&lt;String&gt; words) {
    return words
        .findAll { it.startsWith('j') }
        .collect { it.toUpperCase() }
}

void 'Collections are safe'() {
    given: 'two different collections'
        def cities = null
        def names = ['john', 'jeronimo', 'james']
    when: 'filtering and transforming cities'
        def citiesResult = doSomething(cities)
    and: 'doing the same for names'
        def namesResult = doSomething(names)
    then: 'we should get at least an empty list'
        citiesResult == []
        namesResult == ['JOHN', 'JERONIMO', 'JAMES']
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is because all instances of a <strong><em>GroovyObject</em></strong> have some methods by default (methods
declared in <strong><em>DefaultGroovyMethods</em></strong> class)</p>
</div>
<div class="paragraph">
<p>Unfortunately when dealing with plain pogos or primitive wrappers this functionality doesn&#8217;t
help a lot. Imagine we were using the <strong><em>findAll</em></strong> or <strong><em>collect</em></strong> methods to avoid NPE&#8230;&#8203; that
would be insane don&#8217;t you think ? Or maybe not ?</p>
</div>
<div class="listingblock">
<div class="title">Plain objects are not easy to deal with</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Groovy truth: insane ?'() {
    when: 'mapping values from a non safe reference'
        def result =
            source
                .collect { it }
                .join()
                .toUpperCase()
    then: 'the result should be the expected'
        result == expected
    where: 'possible values could be'
        source | expected
        null   | ""
        "john" | "JOHN"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order not to end doing that kind of coding, Groovy has the <strong><em>elvis</em></strong> operator, which a way
of providing a default value.</p>
</div>
<div class="listingblock">
<div class="title">Elvis comes to the rescue</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Using elvis operator'() {
    when: 'preparing the item'
        def name = source ?: 'john doe' <i class="conum" data-value="1"></i><b>(1)</b>
    then: 'all values should have more than one letter'
        name.toUpperCase() == expected <i class="conum" data-value="2"></i><b>(2)</b>
    where: 'possible values are'
        source  | expected
        null    | "JOHN DOE"
        "peter" | "PETER"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In case the value is null use 'john doe' as value</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can call safely to <strong><em>toUpperCase</em></strong> method</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Another elvis example</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Using elvis operator: another example'() {
    when: 'creating default reference'
        def video2Process = video ?: new ImmutableVideo(name:'unknown') <i class="conum" data-value="1"></i><b>(1)</b>
        def result =
            new ImmutableVideo(
                name: "${video2Process.name}-processed",
                type: "ogg"
            )
    then: 'no exception is thrown even if it was a null ref'
        notThrown(NullPointerException)
    and: 'transformation has been applied'
        result.name?.contains('processed')
        result.type == 'ogg'
    where: 'possible values are'
        video &lt;&lt; [
            null,
            new Video(name: 'documentary.mp4', type: 'mp4')
        ]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Introducing Optional pattern</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Using Optional pattern: dealing with nulls'() {
    when: 'creating default reference'
        Option&lt;ImmutableVideo&gt; result =
            Option
                .from(video) <i class="conum" data-value="1"></i><b>(1)</b>
                .map { ImmutableVideo v -&gt; <i class="conum" data-value="2"></i><b>(2)</b>
                    new ImmutableVideo(
                        name: "${v.name}-processed",
                        type: v.type)
                }
    then: 'no exception is thrown even if it was a null ref'
        notThrown(NullPointerException)
and: 'transformation has been applied'
    result.hasValue() == hasValue
    where: 'possible values are'
        video                                                        | hasValue
            new ImmutableVideo(name: 'documentary.mp4', type: 'mp4') | true
            null                                                     | false
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_functional_patterns">7. Functional Patterns</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(TODO)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_functional_abstractions">8. Functional Abstractions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction">8.1. Introduction</h3>
<div class="paragraph">
<p>Category Theory is a huge topic not related <strong>per se</strong> to programming, but
nowadays is the basis of what functional programming has become today.</p>
</div>
<div class="paragraph">
<p>In this chapter I&#8217;ll try to explain and give examples of some terms
taken from Category Theory and why they could be useful to us as programmers
in our daily work.</p>
</div>
<div class="paragraph">
<p>Many of the examples are based on Haskell programming language.
As a pure functional language is the best place if you want to learn
the basis of functional programming, and also because there aren&#8217;t
much documentation out there other than Haskell. Here you have
my two cents :)</p>
</div>
<div class="paragraph">
<p>I&#8217;m aware that terms like Functor, Monad&#8230;&#8203;etc seem to be something
strange, odd, difficult for most of the programmers born in the OOP era
(including myself by the way).</p>
</div>
<div class="paragraph">
<p>I know it&#8217;s difficult&#8230;&#8203; bad news: it becomes harder along the way, good news
&#8230;&#8203; there is no good news. I&#8217;m jocking good news is that the more you
learn about Category Theory applied to functional programming the more
you understand how to use functional programming at work&#8230;&#8203; but stop!
it&#8217;s about time&#8230;&#8203; <strong>LETS DO THIS</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_monoids">8.2. Monoids</h3>
<div class="paragraph">
<p>Please stick this into your mind&#8230;&#8203;A monoid&#8230;&#8203;.IS NOT A MONAD!!!! I wish it was, monads
would be a lot easier to understand, A <strong>monoid</strong> is a very simple concept,
simple and yet powerful&#8230;&#8203;we&#8217;ll see later on why.  Lets see formal description first.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&#8230;&#8203;a monoid is an algebraic structure with a single associative binary operation and an
identity element.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Ok so imagine we&#8217;ve got a set of numbers called <strong>V</strong> and a binary operation such as <strong>V</strong> x <strong>V</strong> &#8594; <strong>V</strong> then
<strong>V</strong> with <strong>*</strong> is a monoid if satisfies the following axioms:</p>
</div>
<div class="stemblock">
<div class="title">associativity</div>
<div class="content">
\$AA a,b,c in V, (a*b) * c = a * (b*c)\$
</div>
</div>
<div class="paragraph">
<p>That means that you can combine elements from that set, using that operation, in any order. Lets think
about coding&#8230;&#8203; you can build a code module as a <strong>combination of smaller computations</strong>. And because those
computations can be executed <strong>in any order</strong>, they <strong>could be executed in parallel</strong> as well and finally
combine the results of all of them.</p>
</div>
<div class="listingblock">
<div class="title">Monoid</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@Immutable <i class="conum" data-value="1"></i><b>(1)</b>
@EqualsAndHashCode <i class="conum" data-value="2"></i><b>(2)</b>
class V {
    int x, y

    <i class="conum" data-value="3"></i><b>(3)</b>
    def plus(final V v) {
        return new V (x: x + v.x, y: y + v.y)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We will be declaring as immutable all possible objects in order to apply best practices
when trying to use those objects in a multi-threaded environment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We&#8217;are implementing equals() and hashCode() to know which object is which</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Defining our <strong>binary operation</strong></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here we just defined an object declaring a simple binary operation which is the sum of two
given CarFleet objects.</p>
</div>
<div class="listingblock">
<div class="title">Monoids: associativity</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'simple monoid: associativity'() {
    given: 'three different entries'
        def a = new V(x: 1, y: 2)
        def b = new V(x: 1, y: 3)
        def c = new V(x: 1, y: 4)
    expect: 'applying binaryOp'
        ((a + b) + c) == (a + (b + c))
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Applying the operation in a sequential manner.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Applying the operation in no order at all, or at least in a way we cannot predict
the order.</td>
</tr>
</table>
</div>
<div class="stemblock">
<div class="title">identity element</div>
<div class="content">
\$\exists e in V, AA a in V, e * a  = a * e = a\$
</div>
</div>
<div class="paragraph">
<p>Keep in mind that the indentity element could be anything. It&#8217;s not the number one neccesarily, but something
that doesn&#8217;t alter the element operated with it.</p>
</div>
<div class="listingblock">
<div class="title">Monoids: identity</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'simple monoid: identity'() {
    given: 'three different entries'
        def a = new V(x: 1, y: 200)
        def e = new V(x: 0, y: 0)
    expect: 'applying binaryOp'
        (e + a) == (a + e)
        (e + a) == a
        (a + e) == a
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may be wondering why should you bother about building an object like that and having
such operations obeying that kind of rules&#8230;&#8203;
well associativity comes handy when talking about <strong>parallelism</strong>. If it doesn&#8217;t really
matter in which order operations are executed, then you can scatter those operations through
the available cores in your computer.</p>
</div>
<div class="listingblock">
<div class="title">Monoids: parallelism</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'simple monoid: parallelism'() {
    given: 'three different entries'
        def a = new V(x: 1, y: 2)
        def b = new V(x: 1, y: 3)
        def c = new V(x: 1, y: 4)
    when: 'applying binaryOp in order'
        def result1 = [a, b, c].sum() <i class="conum" data-value="1"></i><b>(1)</b>
    and: 'applying in any order'
        def result2 = withPool { [a,b,c].sumParallel() } <i class="conum" data-value="2"></i><b>(2)</b>
    then: 'both results should match'
        result1 == result2
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sum is executed in order</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Sum is executed in parallel (no specific order can be assumed)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_functor">8.3. Functor</h3>
<div class="paragraph">
<p>In Category Theory a Functor is a mapping between categories&#8230;&#8203;WHaAaAAAaaTT?? O_o</p>
</div>
<div class="paragraph">
<p>A Functor represents a container/wrapper of some sort, along with the ability
to apply a function to elements wrapped in the container.</p>
</div>
<div class="paragraph">
<p>Ok, so a Functor is like a container, like a box. It contains a value.
That value can be transformed by functions applied to the container,
not to the value directly.</p>
</div>
<div class="paragraph">
<p>The formal definition of a Functor in Haskell is:</p>
</div>
<div class="listingblock">
<div class="title">Functor definition</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">class Functor f where
    fmap :: (a -&gt; b) -&gt; f a -&gt; f b</code></pre>
</div>
</div>
<div class="paragraph">
<p>What does it mean ? Well it means that in order to build a new instance of a
Functor type the type should implement a fmap method.</p>
</div>
<div class="paragraph">
<p>The fmap method receives a function (a -&gt; b) which transforms an object
of type a in another object of type b, it also receives a Functor of type a
and finally returns a functor of type b.</p>
</div>
<div class="paragraph">
<p>How could we implement this ?</p>
</div>
<div class="sect3">
<h4 id="_example">8.3.1. Example</h4>
<div class="listingblock">
<div class="title">Functor (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package groovyfp.categories;

/**
 *
 * @param &lt;A&gt;
 */
public interface Functor&lt;A&gt; {
    public &lt;B, F extends Functor&lt;B&gt;&gt; F fmap(Function&lt;A,B&gt; fn);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some of the interfaces or classes shown here are implemented in plain
Java&#8482;. I&#8217;m planning to migrate them to Groovy 2.3+ with @CompileStatic any time
soon.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So basically a functor allows us to transform the contained value applying a function.
There&#8217;re some differences between the Java&#8482; implementation and the Haskell one.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(a-&gt;b) becomes Function&lt;A,B&gt;</p>
</li>
<li>
<p>fa parameter will be the instance of the functor itself</p>
</li>
<li>
<p>fb becomes Functor&lt;B&gt;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now imagine we had a function adding 3 to any number. In Haskell we would be seeing this:</p>
</div>
<div class="listingblock">
<div class="title">Haskell example</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">fmap (+3) (Just 1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ll try to reproduce the same behavior, this time with Groovy :) We will be following
these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We need a function receiving a number and returning a number (a-&gt;b)</p>
</li>
<li>
<p>Then the functor will receive the function and will know how to unwrap the
value and after applying the function how to wrap it again.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_function_a_b">8.3.2. Function (a&#8594;b)</h4>
<div class="paragraph">
<p>A function represents a transformation applied to a given input, giving
a certain result.</p>
</div>
<div class="paragraph">
<p>We need a function adding 3 to any given number. Here is a simple java interface
defining a function:</p>
</div>
<div class="listingblock">
<div class="title">Function (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package groovyfp.categories;

/**
 *
 */
public interface Function&lt;A,B&gt; {
    B apply(A input);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because this interface is in fact a functional interface, it could be
substituted by a Closure expression. So instead of building a new class or
building a verbose inner class implementation we will be using a closure
to define a new implementation of the <strong>Function</strong> interface.</p>
</div>
<div class="listingblock">
<div class="title">Function&lt;Integer,Integer&gt;</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Building a simple function'() {
    given: 'a function instance using closures'
        Function&lt;Integer,Integer&gt; plus_3 = { Integer v -&gt;
            v + 3
        } as Function&lt;Integer,Integer&gt;
    when:  'using it'
        Integer result = plus_3.apply(5)
    then: 'the value to be the number plus 3'
        result == 8
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Be aware that because closures only declare the return type you should add
the type to the closure parameter if you care about input type.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_functor_a">8.3.3. Functor&lt;A&gt;</h4>
<div class="paragraph">
<p>Well now we need an instance of a functor of type <strong>A</strong>, pass to the functor
our previously created function and expect to receive a certain value with
a certain type.</p>
</div>
<div class="listingblock">
<div class="title">Functor&lt;Integer&gt;</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'applying a given function to a functor'() {
    given: 'a function'
        Function&lt;Integer,Integer&gt; plus_3 = { Integer v -&gt; v + 3 }
    and: 'a functor implementation. This time Maybe.Just implements functor'
        Functor&lt;Integer&gt; boxOfFive = Maybe.just(5)
    when: 'applying the function to functor to get another functor'
        Functor&lt;Integer&gt; result = boxOfFive.fmap(plus_3)
    then: 'the result should be the expected'
        result.typedRef.value == 8
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok but how Maybe.Just gets something and transform it to another functor. Lets see
what the fmap implementation does:</p>
</div>
<div class="listingblock">
<div class="title">Maybe Functor#fmap implementation</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Override
public &lt;B, F extends Functor&lt;B&gt;&gt; F fmap(Function&lt;JUST, B&gt; fn) {
    return (F) just(fn.apply(this.getTypedRef().getValue()));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>First I&#8217;ll try to describe which types are involved:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JUST is the value contained by the Maybe instance (which among other things is a functor).</p>
</li>
<li>
<p>&lt;B&gt; is the type of the function applied. Then
the Maybe implementation wraps that value into another instance of a functor
(this time another Just instance).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Basically here the fmap method takes as an argument a function transforming
the contained value in the source functor and then wraps it again in another
functor instance.</p>
</div>
<div class="paragraph">
<p>By the way, althought <strong>fmap</strong> is implemented in <strong>Functor</strong> in languages
like Haskell, you won&#8217;t see <strong>fmap</strong> being invoked like "myObject.fmap(&#8230;&#8203;)" but instead
you will find something like <strong>fmap(functor, function)</strong></p>
</div>
<div class="paragraph">
<p>In the source code you will see that there&#8217;re several methods adding
some syntactic sugar to inner functors/applicative/monads methods mimicking the way
Haskell does it.</p>
</div>
<div class="listingblock">
<div class="title">Public API</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">import static groovyfp.categories.Fn.val
import static groovyfp.categories.Fn.fmap</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Functor&lt;Integer&gt;</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'applying a given function to a functor with public api'() {
    when: 'using fmap function to execute the fmap method from Just'
        Functor&lt;Integer&gt; result =
            fmap(Maybe.just(5)) { Integer x -&gt;
                x + 3
            }
    then: 'executing val() to get Just inner value'
        val(result) == 8
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_plain_groovy">8.3.4. Plain Groovy</h4>
<div class="paragraph">
<p>Well under the hood many of the methods added to the Groovy API (api, gapi, gdk) resemble
monadic behaviors. For example there is the <strong>with</strong> method all Groovy objects have. Although
it could be seen more like a <strong>bind</strong> action (we&#8217;ll cover it later on) we can create a lighter
version of <strong>fmap</strong> with this <strong>with</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Groovy map</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def map(Object o, Closure function) {
    o?.with(function)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we&#8217;ll see later on, many monadic estructures don&#8217;t execute functions when they detect
something went wrong, or the type at a hand means nothing can be executed (a Maybe.Nothing ,
Either.Left value, or a Try.Failure values could be an example for that)</p>
</div>
<div class="paragraph">
<p>This <strong>with</strong> on steroids executes the closure (function) passed as parameter when
the value exists (and represents a Groovy truth of couse ;) ). Notice was achieved
by using the <strong>safe</strong> operator from Groovy (foo?.unsafeMethod()).</p>
</div>
<div class="listingblock">
<div class="title">Groovy map</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Groovy light version of fmap'() {
    when: 'using fmap function to execute the fmap method from Just'
        def result = map(input) { Integer x -&gt;
            map(x + 3) { Integer y -&gt;
                y
            }
        }
    then: 'executing val() to get Just inner value'
        result == expected // 8 and null
    where:
        input    | expected
            5    | 8
            null | null
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And I can&#8217;t finish this section without talking about <strong>collect</strong>.
<a href="http://groovy.codehaus.org/groovy-jdk/java/util/Collection.html#collect(groovy.lang.Closure)"><strong>Collect</strong></a>
is the closest version of fmap I can think about within Groovy. Collect transforms each item in a collection
into something else.</p>
</div>
<div class="paragraph">
<p>Same way our <strong>map</strong> method was safe so is <strong>collect</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Groovy collect</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Groovy collect is "similar" to fmap'() {
    when: 'Applying a function to collect'
        def result =
            input.collect { Integer x -&gt;
                x + 1
            }
    then: 'checking'
        result == expected
    where: 'possible messy values'
        input     | expected
            [1,2] | [2,3]
            null  | []
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So&#8230;&#8203; why don&#8217;t we make a better world and use both ideas combined ?</p>
</div>
<div class="listingblock">
<div class="title">Groovy collect</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Groovy light version of fmap and collect combined'() {
    when: 'Making the world a safer place'
        def result =
            input.collect { Integer x -&gt;
                map(x) { Integer y -&gt;
                    (y + 1) * 2
                }
            }
    then: 'checking'
        result == expected
    where: 'possible messy values are'
        input         | expected
            [1, 2]    | [4, 6]
            [1, null] | [4,null]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_applicative_functor">8.4. Applicative Functor</h3>
<div class="paragraph">
<p>Remember I was saying a Functor is a container, a box if you like, containing
a simple value ? You can think about Applicative like a Functor containing
a Function. This time the box contains a Function.</p>
</div>
<div class="paragraph">
<p>Why then the name of Applicative ? I&#8217;m not quite sure, but
I think it came from the idea that a function <strong>can be applied</strong>
to some other values.</p>
</div>
<div class="paragraph">
<p>In Haskell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">(&lt;*&gt;) :: Applicative f =&gt; f (a-&gt;b) -&gt; (f a -&gt; f b)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time instead of containing a plain value the functor has a function. So
we can read the Haskell function as a function receiving an applicative f (a-&gt;b) (a
functor containing a function transforming from a to b) and returns the
transformation from a functor containing a to a functor containing b (f a -&gt; f b).</p>
</div>
<div class="sect3">
<h4 id="_example_2">8.4.1. Example</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package groovyfp.categories;

/**
 *
 * @param &lt;A&gt;
 */
public interface Applicative&lt;A&gt; extends Functor&lt;A&gt; {
    public &lt;U extends Type&lt;A&gt;&gt; U getTypedRef();
    public &lt;B&gt; Applicative&lt;B&gt; fapply(Applicative&lt;Function&lt;A,B&gt;&gt; afn);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have included in our Java&#8482; version a way of accessing the inner value
forcing any Applicative to implement the getValue() method.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Instead of getValue returning a raw value I&#8217;ve implemented getTypedRef which
returns a wrapper having the raw instance.
I did it becauseI didn&#8217;t found a solution to resolve the problem of having the ListMonad sharing
the same interface with Monads sharing single values and still respecting the
fmap, fapply and bind methods. I&#8217;m not perfect so I will be very happy if
someone gives me a better solution :)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But the  most important method is fapply which in in charge of receiving another
applicative and use the value of that applicative and apply it to the inner value
of the instance of the source applicative.</p>
</div>
<div class="paragraph">
<p>Lets take a look to the implementation of the fapply method in the
Maybe.Right class we can see how it works.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Override
public &lt;B&gt; Just&lt;B&gt; fapply(Applicative&lt;Function&lt;JUST, B&gt;&gt; afn) {
    return this.fmap(afn.getTypedRef().getValue());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>How can we use it ?</p>
</div>
<div class="paragraph">
<p>In this example I&#8217;m using implementations of Maybe. This implementation is not
only an Applicative but a Functor (which is implied) and a Monad. Instead
of creating object with new operator every object has a static method to do it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">import static Maybe.just
import static Maybe.nothing
import groovyfp.categories.Maybe.Nothing</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Applicative: Maybe applicative implementation'() {
    when: 'combining two closures'
        def inc = { Integer v -&gt; v + 1 }
        def byTwo = { Integer v -&gt; v * 2 }
    and: 'using the combination as a Function'
        def combination = (inc &gt;&gt; byTwo) as Function
    then: 'if the value is nothing the function shouldnt be applied'
        nothing().fapply(just(combination)).typedRef.value == null <i class="conum" data-value="1"></i><b>(1)</b>
    and: 'otherwise if the initial value is correct the function will work'
        just(1).fapply(just(combination)).typedRef.value == 4 <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The implementation of the Maybe.Nothing fapply method doesn&#8217;t apply the
function to the current instance and returns  an instance of new Nothing(null)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The implementation of the Maybe.Just fapply method applies current value
to the function contained within the Applicative passed as parameter.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monad">8.5. Monad</h3>
<div class="paragraph">
<p>What is a Monad ?</p>
</div>
<div class="paragraph">
<p>While Functor applied a function to a wrapped value, and an Applicative
applied a wrapped function to a wrapped value, a Monad applies a function
to a wrapped value and returns a wrapped value.</p>
</div>
<div class="paragraph">
<p>Because Monad is an Applicative and an Applicative is a Functor, likewise
a Monad has some inherit methods such as fmap or  fapply. But the method
that makes a Monad a Monad is the bind method (or &gt;&gt;= which is its alias
in Haskell).</p>
</div>
<div class="paragraph">
<p>How does bind looks like ? Like always , first step, Haskell syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-haskell" data-lang="haskell">class Monad m where
    (&gt;&gt;=) :: m a -&gt; (a -&gt; m b) -&gt; m b</code></pre>
</div>
</div>
<div class="paragraph">
<p>A bind method receives a wrapped value m a then a function (a -&gt; m b) which
transforms the wrapped value to another wrapped value, and finally returns the
transformation result m b.</p>
</div>
<div class="paragraph">
<p>In my humble representation of a Monad type in Java&#8482; I came up with the
following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package groovyfp.categories;

/**
 *
 * @param &lt;A&gt;
 */
public interface Monad&lt;A&gt; extends Applicative&lt;A&gt; {
    public &lt;B,M extends Monad&lt;B&gt;&gt; M bind(Function&lt;A,M&gt; fn);
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_maybe">8.5.1. Maybe</h4>
<div class="paragraph">
<p>The Maybe is normally used to avoid asking whether the value is null or it
can contain any value. That&#8217;s why the Maybe object has two children:
Maybe.Just and Maybe.Nothing.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the JDK 8 you can find the Optional type. Sometimes is also called
Option.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As we&#8217;ll be seeing along this chapter is that monads like Maybe, Either or
ListMonad will allow to apply functions over the wrapped value, only if the
wrapped value is considered <strong>valid</strong>. Otherwise the wrapped value will be
returned.</p>
</div>
<div class="paragraph">
<p>To see how to use Maybe lets use it in a simple exercise:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Given a number, I want to divide it by half two times, and then if still
not decimal, multiplied by three.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Because all even numbers will become decimals as soon as I try to dividing them
by half I want to stop the process as soon as the process detects that number
is no longer eligible to success.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'Monad: using maybe to shortcircuit a process'() {
    given: 'a function dividing only even numbers'
        def half = { BigDecimal possible -&gt;
            return possible.intValue() % 2 == 0 ?
                Maybe.just(possible.div(2)) :
                Maybe.nothing()
        }
    and: 'another function multiplying by three'
        def threeTimes = { BigDecimal possible -&gt;
            return Maybe.just(possible * 3)
        }
    when: 'starting the process'
        Integer result =
            Maybe.just(sampleNumber)
                .bind(half) <i class="conum" data-value="1"></i><b>(1)</b>
                .bind(half) <i class="conum" data-value="2"></i><b>(2)</b>
                .bind(threeTimes) <i class="conum" data-value="3"></i><b>(3)</b>
                .typedRef.value
    then: 'checking the result'
        result == expected
    where: 'sample numbers and expectations are'
        sampleNumber | expected
            100      |    75
            200      |   150
             50      |   null
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>tries to divide, if not even returns nothing otherwise returns division result.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>tries again to divide the number under the same premises.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If division ended successfully only then applies multiplication.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The nice thing about this plan is that if any of the previous steps ended with
a Maybe.Nothing instance the process won&#8217;t go any further.</p>
</div>
<div class="paragraph">
<p>In order to understand what happens underneath, why process doesn&#8217;t continue,
I would like to show you both implementation of Maybe.Just and Maybe.Nothing.</p>
</div>
<div class="paragraph">
<p>While Maybe.Just applies the function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Override
public &lt;B, M extends Monad&lt;B&gt;&gt; M bind(Function&lt;JUST, M&gt; fn) {
    return fn.apply(getTypedRef().getValue());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maybe.Nothing like its name, <strong>does nothing</strong> but to return the current value :P</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Override
public &lt;B, F extends Functor&lt;B&gt;&gt; F fmap(Function&lt;NOTHING, B&gt; fn) {
    return (F) new Nothing();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes it would be useful to have an alternative when there&#8217;s no value. That&#8217;s
what the method or does. It makes the monad to return the alternative value in
case there was no value. Otherwise the current value is returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'testing maybe alternatives (I)'() {
    when: 'something has no value and adding an alternative'
        Maybe&lt;String&gt; name = nothing().or(just("john"))
    then: 'we should get the alternative'
        name.typedRef.value == 'john'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s pretty clear in the previous example, but it is even clearer when you do
something ( a transformation for example) with the current inner value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">void 'testing maybe alternatives (III)'() {
    when: 'something has value and adding an alternative'
        Maybe&lt;Integer&gt; nameLength =
            just("mario")
                .bind { nothing() } // some fancy logic here
                .or(just(0))
    then: 'we should get first value'
        nameLength.typedRef.value == 0
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_either">8.5.2. Either</h4>
<div class="paragraph">
<p>Either monad is also one of the classics. The Either monad instance can
represent correct or error.</p>
</div>
<div class="paragraph">
<p>As imperative programmer I&#8217;m used to choose between branches in my code using
conditional structures such as if. As Groovy programmer I&#8217;ve gone one step
further and I&#8217;ve met the Groovy Truth that helps me a lot classifying
instances between those which could be seen as a false statement and those
which can be taken as a true statement.</p>
</div>
<div class="paragraph">
<p>But what if we go beyond ? What if we had a type saying it could be right or
wrong depending on its own but still having content ?.</p>
</div>
<div class="paragraph">
<p>The following example tries to search certain type of people from a given list.
The search will stop once a person has been found with any of the given rules.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">void 'using Either to chain failback searchs'() {
    given:'a base function to search by a certain criteria'
        def baseSearch = { Closure&lt;Boolean&gt; search -&gt; <i class="conum" data-value="1"></i><b>(1)</b>
            return { List sample -&gt;
                def pr = sample.find(search)
                // if found then return left to shortcircuit further
                // searchs
                pr ? Either.left(pr) : Either.right(sample)
            }
        }
    and: 'composed criterias on top of the base function'
        // they become Function&lt;A,Monad&lt;B&gt;&gt;
        def lookByNameJohn = baseSearch { it.name == 'john' } <i class="conum" data-value="2"></i><b>(2)</b>
        def lookByAgeGreaterThan = baseSearch { it.age &gt; 50 }
        def lookByCity = baseSearch { it.city == 'dublin' }
    when: 'chaining all search criterias'
        Either result = <i class="conum" data-value="3"></i><b>(3)</b>
            Either.right(sample)
                .bind(lookByNameJohn)
                .bind(lookByAgeGreaterThan)
                .bind(lookByCity)
    then: 'there should be only one item'
        result.isLeft()
        result.typedRef.value.name == name_of_the_result
    where: 'samples used in this spec are'
        sample          |   name_of_the_result
        firstSample     |       'john'
        secondSample    |       'peter'
        thirdSample     |       'rob'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>First of all, I need to apologise because in this example It seems I&#8217;ve used Either just
to do the opposite. This time think Either.Left as something telling us to
stop looking because we&#8217;ve found what we were looking for.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>baseSearch is a function that returns another function.
That inner function returns an Either.Left instance with the result inside
if the search function passed as parameter succeeded. I want the function to
return Either.Left because I know when an Either.Left is returned no further
action is done. And because I&#8217;ve found what I was looking for, I don&#8217;t want the
search to go any further.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>I&#8217;ve created three different functions valid to be used in an fmap function. That
means they receive an unwrapped value but they will return a wrapped value.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Given the source we will try to apply three types of search in order to find
someone. Because the rules of the monad, I know if the first search fails the
second will be triggered, and so on. In case any of them succeed the value will be
return immediately.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_listmonad">8.5.3. ListMonad</h4>
<div class="paragraph">
<p>Collections in general are one of the most used data structures ever.
Some languages use collections only as data structures and some others make
them implement monadic semantics in order to be able to do things like
list comprehensions.</p>
</div>
<div class="paragraph">
<p>According to <strong>Wikipedia</strong> a list comprehension is:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A list comprehension is a syntactic construct available in some programming
languages for creating a list based on existing lists</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Wikipedia
</div>
</div>
<div class="paragraph">
<p>I would add that implementations differ in which are capable of handling
streams and those which don&#8217;t.</p>
</div>
<div class="paragraph">
<p>First of all I&#8217;m would like to start with a basic finite example. Like we
did before, lets sneak a little bit on how <strong>Haskell</strong> does it ;)</p>
</div>
<div class="paragraph">
<p>(TODO)</p>
</div>
</div>
<div class="sect3">
<h4 id="_try">8.5.4. Try</h4>
<div class="paragraph">
<p>Nowadays JVM languages deal with exceptions using <strong>try-catch</strong> blocks. The
problem is that these constructions force programmers to build their code in
a certain way.</p>
</div>
<div class="paragraph">
<p><strong>Try</strong> monad wraps the result of a given computation. That computation could
either end on a desired value, having an instance of <strong>Success</strong>,
or could throw an exception, having an instance of <strong>Failure</strong> instead.</p>
</div>
<div class="paragraph">
<p>Like <strong>Either</strong>, composition has a special importance here, due to
the fact that when having a <strong>Failure</strong> instance all possible actions
applied over it will always return the same failure.</p>
</div>
<div class="paragraph">
<p>This first example tries to parse an invalid number and add one to it.</p>
</div>
<div class="listingblock">
<div class="title">Parse a possible number</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def 'parsing a non valid number: Try'() {
    when: 'trying to parse a non valid number'
        Function inc = { x -&gt; x + 1 }
        Try result1 = Try { Integer.parseInt("2a")} <i class="conum" data-value="1"></i><b>(1)</b>
        Try result2 = fmap(result1, inc) <i class="conum" data-value="2"></i><b>(2)</b>
    then: 'computation failed'
        result1.isFailure()
    and: 'any possible composition will return the same failure'
        result2.isFailure()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see both behaviors.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First of all the given function fails and
the instance returned is an instance of <strong>Failure</strong> we know that because only
<strong>Failure</strong> instances return <strong>true</strong> when calling to <strong>isFailure()</strong> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Besides that we can also notice that using a failure instance to create
further function composition will end returning the same failure, which is the
same as saying that no further function will ever succeed using that failure.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When having a <strong>Failure</strong> instance, the exception that caused it is also wrapped
within the instance, and you could whether get it to inspect it, or throw it
like any other exception.</p>
</div>
<div class="listingblock">
<div class="title">throwException</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def 'throwing an exception'() {
    when: 'doing something wrong'
        Try.Failure failure = Try { 0.div(0) }
        <i class="conum" data-value="1"></i><b>(1)</b>
        assert failure.exception instanceof ArithmeticException
    and: 'wants to propagate the exception'
        failure.throwException() <i class="conum" data-value="2"></i><b>(2)</b>
    then:'the exception will be thrown as usual'
        thrown(ArithmeticException)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can get the wrapped exception</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Or throw the exception instead</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Normally when having an exception we would like to react somehow. Sometimes
we may want to set, for example a default value in case something went wrong.</p>
</div>
<div class="paragraph">
<p>In our example I would like to get zero in case the number was not valid.
Then I would like to add one to that given number.</p>
</div>
<div class="listingblock">
<div class="title">TryOrElse</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def 'reacting with TryElse'() {
    given: 'the functions used in this example'
        def returnZero = { 0 }
        def increment = { Integer x -&gt; x + 1 }
        def parseInt = { String number -&gt;
            return {
               Integer.parseInt(number)
            }
        }
    when: 'trying to parse any type of value'
        Try result =
            fmap(
                TryOrElse( <i class="conum" data-value="1"></i><b>(1)</b>
                    parseInt(next),
                    returnZero
                ),
                increment)
    then:'the value should always be greater than 0'
        val(result) &gt;= 1
    where: 'values can be valid or invalid'
        next &lt;&lt; ["1","2a","3"]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can notice how we use <strong>TryOrElse</strong> to react when the main action
failed. Then the second action will be executed instead. I think this
is a very common scenario and this way of coding could be very useful
and descriptive.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Of course, if the alternative function fails the <strong>TryOrElse</strong> execution
will return a <strong>Failure</strong> instance anyway. So, the next question could be:
Is there any way of recovering from a failure instance once we&#8217;ve executed
both main and alternative actions ?</p>
</div>
<div class="paragraph">
<p>Well there is the <strong>recover()</strong> method. This method has two arguments the
possible <strong>Failure</strong> instance, and the <strong>Success</strong> instance to use instead.</p>
</div>
<div class="listingblock">
<div class="title">recover()</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">def 'using recover()'() {
    when: 'you cant always get what you want'
        Try something =
            TryOrElse(
                { 0.div(0) }, // WRONG
                { new Date() + "1" } // WORST
            )
        Try anything = recover(something, Try { 0 })
    then: 'you can always get what you need :P'
        val(anything) == 0

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_persistent_collections">9. Persistent collections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(TODO)</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2014-10-27 23:10:57 +00:00
</div>
</div>
</body>
</html>